{"version":3,"sources":["../../src/svg/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","timeRange","carpet","$carpet","find","tooltip","CarpetplotTooltip","margin","left","right","top","bottom","width","height","min","max","xFrom","xTo","days","chartHeight","chartWidth","chartTop","chartBottom","xAxisHeight","yAxisWidth","yScale","xScale","legendHeight","colorScale","fragment","mouseUpHandler","originalPointColor","$canvas","selection","active","x1","x2","events","on","render","renderingCompleted","addCarpetplot","getMinMax","getColorScale","addCarpetplotSvg","addAxes","addLegend","addPoints","Math","floor","remove","d3","select","append","attr","legend","show","LEGEND_HEIGHT","LEGEND_TOP_MARGIN","addYAxis","getYAxisWidth","Y_AXIS_TICK_PADDING","addXAxis","getXAxisHeight","yAxis","selectAll","style","xAxis","scaleTime","domain","moment","startOf","add","range","axisLeft","ticks","getYAxisTicks","tickFormat","value","format","tickSizeInner","tickSizeOuter","tickPadding","call","posY","posX","yAxisGroup","axisText","nodes","text","$","outerWidth","count","Y_AXIS_TICK_MIN_SIZE","step","ceil","timeHour","every","time","length","diff","axisBottom","getXAxisTicks","timeFormat","tickSize","dayWidth","addDayTicks","timeSaturday","timeMonday","axis","empty","totalHeight","node","from","to","X_AXIS_TICK_MIN_SIZE","timeDay","timeMonth","container","insert","pointScale","scaleLinear","points","enter","d","i","buckets","map","color","nullColor","toDate","$points","highlightPoint","resetPointHighLight","event","target","highlightColor","darker","currentPoint","scale","isSet","stats","colorScheme","_","colorSchemes","colorInterpolator","colorScaleInverted","invert","contextSrv","user","lightTheme","start","end","scaleSequential","prop","undefined","onMouseDown","pos","getMousePos","x","onMouseUp","document","one","unbind","selectionRange","abs","MIN_SELECTION_WIDTH","timeFrom","timeTo","timeSrv","setTime","utc","clearSelection","onMouseLeave","clearCrosshair","onMouseMove","destroy","drawSelection","drawCrosshair","getBoundingClientRect","pageX","window","scrollX","y","pageY","scrollY","posX1","posX2","selectionX","selectionWidth","drawColorLegend","legendWidth","drawLegend","decimals","unitFormat","formatter","valueFormatter","legendContainer","labelMargin","minLabel","createMinMaxLabel","maxLabel","$minLabel","$maxLabel","labelHeight","labelWidth","legendMargin","labelY","legendScale","legendAxis","rangeStep","legendColorScale","valuesRange","getFragment","appEvents","tickStep","DEFAULT_X_TICK_SIZE_PX"],"mappings":"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","file":"rendering.js","sourcesContent":["import d3 from 'd3';\r\nimport _ from 'lodash';\r\nimport { appEvents, contextSrv } from 'app/core/core';\r\nimport { tickStep } from 'app/core/utils/ticks';\r\nimport moment from 'moment';\r\nimport $ from 'jquery';\r\n\r\nimport { getFragment } from '../fragments';\r\nimport CarpetplotTooltip from './tooltip';\r\nimport { valueFormatter } from '../formatting';\r\n\r\nconst\r\n  DEFAULT_X_TICK_SIZE_PX = 100,\r\n  X_AXIS_TICK_MIN_SIZE = 100,\r\n  Y_AXIS_TICK_PADDING = 5,\r\n  Y_AXIS_TICK_MIN_SIZE = 20,\r\n  MIN_SELECTION_WIDTH = 2,\r\n  LEGEND_HEIGHT = 40,\r\n  LEGEND_TOP_MARGIN = 10;\r\n\r\nexport default function link(scope, elem, attrs, ctrl) {\r\n  let data, panel, timeRange, carpet;\r\n\r\n  const $carpet = elem.find('.carpetplot-panel');\r\n  const tooltip = new CarpetplotTooltip($carpet, scope);\r\n\r\n  const margin = { left: 25, right: 15, top: 10, bottom: 65 };\r\n\r\n  let width, height,\r\n    min, max,\r\n    xFrom, xTo, days,\r\n    chartHeight, chartWidth,\r\n    chartTop, chartBottom,\r\n    xAxisHeight, yAxisWidth,\r\n    yScale, xScale,\r\n    legendHeight,\r\n    colorScale, fragment,\r\n    mouseUpHandler,\r\n    originalPointColor,\r\n    $canvas;\r\n\r\n  const selection = {\r\n    active: false,\r\n    x1: -1,\r\n    x2: -1\r\n  };\r\n\r\n  ctrl.events.on('render', () => {\r\n    render();\r\n    ctrl.renderingCompleted();\r\n  });\r\n\r\n  function addCarpetplot() {\r\n    if (!data.data) { return; }\r\n\r\n    [min, max] = getMinMax();\r\n    colorScale = getColorScale(min, max);\r\n\r\n    addCarpetplotSvg();\r\n    addAxes();\r\n    addLegend();\r\n    addPoints(colorScale);\r\n  }\r\n\r\n  function addCarpetplotSvg() {\r\n    width = Math.floor($carpet.width());\r\n    height = ctrl.height;\r\n\r\n    if (carpet) {\r\n      carpet.remove();\r\n    }\r\n\r\n    carpet = d3.select($carpet[0])\r\n      .append('svg')\r\n      .attr('width', width)\r\n      .attr('height', height);\r\n  }\r\n\r\n  function addAxes() {\r\n    legendHeight = panel.legend.show ? LEGEND_HEIGHT + LEGEND_TOP_MARGIN : 0;\r\n    chartHeight = height - margin.top - margin.bottom - legendHeight;\r\n    chartTop = margin.top;\r\n    chartBottom = chartTop + chartHeight;\r\n\r\n    addYAxis();\r\n    yAxisWidth = getYAxisWidth() + Y_AXIS_TICK_PADDING;\r\n    chartWidth = width - yAxisWidth - margin.right;\r\n\r\n    addXAxis();\r\n    xAxisHeight = getXAxisHeight();\r\n\r\n    if (!panel.yAxis.show) {\r\n      carpet.select('.axis-y').selectAll('line').style('opacity', 0);\r\n    }\r\n\r\n    if (!panel.xAxis.show) {\r\n      carpet.select('.axis-x').selectAll('line').style('opacity', 0);\r\n      carpet.selectAll('.axis-x-weekends').selectAll('line').style('opacity', 0);\r\n    }\r\n  }\r\n\r\n  function addYAxis() {\r\n    scope.yScale = yScale = d3.scaleTime()\r\n      .domain([moment().startOf('day').add(1, 'day'), moment().startOf('day')])\r\n      .range([chartHeight, 0]);\r\n\r\n    const yAxis = d3.axisLeft(yScale)\r\n      .ticks(getYAxisTicks())\r\n      .tickFormat((value) => moment(value).format('HH:mm'))\r\n      .tickSizeInner(0 - width)\r\n      .tickSizeOuter(0)\r\n      .tickPadding(Y_AXIS_TICK_PADDING);\r\n\r\n    carpet.append('g')\r\n      .attr('class', 'axis axis-y')\r\n      .call(yAxis);\r\n\r\n    const posY = margin.top;\r\n    const posX = getYAxisWidth() + Y_AXIS_TICK_PADDING;\r\n\r\n    const yAxisGroup = carpet.select('.axis-y');\r\n    yAxisGroup.attr('transform', `translate(${posX},${posY})`);\r\n    yAxisGroup.select('.domain').remove();\r\n    yAxisGroup.select('.tick:first-child').remove();\r\n    yAxisGroup.selectAll('.tick line').remove();\r\n  }\r\n\r\n  function getYAxisWidth() {\r\n    const axisText = carpet.selectAll('.axis-y text').nodes();\r\n    return d3.max(axisText, (text) => $(text).outerWidth());\r\n  }\r\n\r\n  function getYAxisTicks() {\r\n    const count = chartHeight / Y_AXIS_TICK_MIN_SIZE;\r\n    const step = Math.max(2, Math.ceil(24 / count));\r\n    return d3.timeHour.every(step);\r\n  }\r\n\r\n  function addXAxis() {\r\n    xFrom = moment(data.data[0].time).startOf('day');\r\n    xTo = moment(data.data[data.data.length - 1].time).startOf('day').add(1, 'day');\r\n    days = xTo.diff(xFrom, 'days');\r\n\r\n    scope.xScale = xScale = d3.scaleTime()\r\n      .domain([xFrom, xTo])\r\n      .range([0, chartWidth]);\r\n\r\n    const xAxis = d3.axisBottom(xScale)\r\n      .ticks(getXAxisTicks(xFrom, xTo))\r\n      .tickFormat(d3.timeFormat('%a %m/%d'))\r\n      .tickSize(chartHeight);\r\n\r\n    const dayWidth = chartWidth / days;\r\n\r\n    const posY = margin.top;\r\n    const posX = yAxisWidth;\r\n    carpet.append('g')\r\n      .attr('class', 'axis axis-x')\r\n      .attr('transform', `translate(${posX},${posY})`)\r\n      .call(xAxis)\r\n      .selectAll('text')\r\n      .style('text-anchor', 'end')\r\n      .attr('dx', '-.8em')\r\n      .attr('dy', '.15em')\r\n      .attr('y', 0)\r\n      .attr('transform', `translate(${5 + dayWidth / 2},${posY + chartHeight - 10}) rotate(-65)`);\r\n    carpet.select('.axis-x').selectAll('.tick line, .domain').remove();\r\n    carpet.select('.axis-x').select('.tick:last-child').remove();\r\n\r\n    if (dayWidth >= 4) {\r\n      addDayTicks(posX, posY, d3.timeSaturday.every(1));\r\n      addDayTicks(posX, posY, d3.timeMonday.every(1));\r\n    }\r\n  }\r\n\r\n  function addDayTicks(posX, posY, range) {\r\n    const ticks = d3.axisBottom(xScale)\r\n      .ticks(range)\r\n      .tickSize(chartHeight);\r\n    carpet.append('g')\r\n      .attr('class', 'axis-x-weekends')\r\n      .attr('transform', `translate(${posX},${posY})`)\r\n      .call(ticks)\r\n      .selectAll('text').remove();\r\n    carpet.select('.axis-x-weekends .domain').remove();\r\n  }\r\n\r\n  function getXAxisHeight() {\r\n    const axis = carpet.select('.axis-x');\r\n    if (!axis.empty()) {\r\n      const totalHeight = $(axis.node()).height();\r\n      return Math.max(totalHeight, totalHeight - chartHeight);\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  function getXAxisTicks(from, to) {\r\n    const count = chartWidth / X_AXIS_TICK_MIN_SIZE;\r\n    const step = Math.ceil(days / count);\r\n    if (step < 7) {\r\n      return d3.timeDay.every(1);\r\n    }\r\n    if (step < 28) {\r\n      return d3.timeMonday.every(1);\r\n    }\r\n    return d3.timeMonth.every(1);\r\n  }\r\n\r\n  function addPoints(colorScale) {\r\n    const container = carpet.insert('g', ':first-child')\r\n      .attr('class', 'carpet-container')\r\n      .attr('transform', `translate(${yAxisWidth},${margin.top})`);\r\n\r\n    $canvas = $(container.node());\r\n\r\n    const width = Math.max(0, chartWidth / days);\r\n    const height = Math.max(0, chartHeight / fragment.count);\r\n\r\n    const pointScale = d3.scaleLinear()\r\n      .domain([fragment.count, 0])\r\n      .range([chartHeight, 0]);\r\n\r\n    const points = container\r\n      .selectAll('.carpet-col')\r\n      .data(data.data)\r\n      .enter()\r\n      .selectAll('.carpet-point')\r\n      .data((d, i) => d.buckets.map(value => ({\r\n        value,\r\n        time: d.time\r\n      })))\r\n      .enter()\r\n      .append('rect')\r\n      .attr('class', 'carpet-point')\r\n      .attr('fill', ({ value }) => value === null ? panel.color.nullColor : colorScale(value))\r\n      .attr('x', (d) => xScale(d.time.toDate()))\r\n      .attr('y', (d, i) => pointScale(i))\r\n      .attr('width', width)\r\n      .attr('height', height);\r\n\r\n    // const cols = container\r\n    //   .selectAll('.carpet-col')\r\n    //   .data(data.data)\r\n    //   .enter()\r\n    //   .append('g')\r\n    //   .attr('transform', (day) => `translate(${xScale(day.time.toDate())},0)`);\r\n\r\n    // const points = cols\r\n    //   .selectAll('.carpet-point')\r\n    //   .data((d, i) => d.buckets)\r\n    //   .enter()\r\n    //   .append('rect')\r\n    //   .attr('class', 'carpet-point')\r\n    //   .attr('fill', value => value === null ? panel.color.nullColor : colorScale(value))\r\n    //   .attr('x', 0)\r\n    //   .attr('y', (d, i) => pointScale(i))\r\n    //   .attr('width', width)\r\n    //   .attr('height', height);\r\n\r\n    const $points = $carpet.find('.carpet-point');\r\n    $points\r\n      .on('mouseenter', highlightPoint)\r\n      .on('mouseleave', resetPointHighLight);\r\n  }\r\n\r\n  function highlightPoint(event) {\r\n    const color = d3.select(event.target).style('fill');\r\n    const highlightColor = d3.color(color).darker(1);\r\n    const currentPoint = d3.select(event.target);\r\n    originalPointColor = color;\r\n    currentPoint.style('fill', highlightColor);\r\n  }\r\n\r\n  function resetPointHighLight(event) {\r\n    d3.select(event.target)\r\n      .style('fill', originalPointColor);\r\n  }\r\n\r\n  function getMinMax() {\r\n    const { min, max } = panel.scale;\r\n    return [\r\n      isSet(min) ? min : data.stats.min,\r\n      isSet(max) ? max : data.stats.max\r\n    ];\r\n  }\r\n\r\n  function getColorScale(min, max) {\r\n    const colorScheme = _.find(ctrl.colorSchemes, { value: panel.color.colorScheme });\r\n    const colorInterpolator = d3[colorScheme.value];\r\n    const colorScaleInverted = colorScheme.invert === 'always' || (colorScheme.invert === 'dark' && !contextSrv.user.lightTheme);\r\n\r\n    const start = colorScaleInverted ? max : min;\r\n    const end = colorScaleInverted ? min : max;\r\n\r\n    return d3\r\n      .scaleSequential(colorInterpolator)\r\n      .domain([start, end]);\r\n  }\r\n\r\n  function isSet(prop) {\r\n    return prop !== undefined && prop !== null && prop !== '';\r\n  }\r\n\r\n  function onMouseDown(event) {\r\n    selection.active = true;\r\n    const pos = getMousePos(event);\r\n    const posX = pos.x + yAxisWidth;\r\n    selection.x1 = posX;\r\n\r\n    mouseUpHandler = () => onMouseUp();\r\n\r\n    $(document).one('mouseup', mouseUpHandler);\r\n  }\r\n\r\n  function onMouseUp() {\r\n    $(document).unbind('mouseup', mouseUpHandler);\r\n    mouseUpHandler = null;\r\n    selection.active = false;\r\n\r\n    const selectionRange = Math.abs(selection.x2 - selection.x1);\r\n\r\n    if (selection.x2 >= 0 && selectionRange > MIN_SELECTION_WIDTH) {\r\n      const timeFrom = xScale.invert(Math.min(selection.x1, selection.x2) - yAxisWidth);\r\n      const timeTo = xScale.invert(Math.max(selection.x1, selection.x2) - yAxisWidth);\r\n\r\n      ctrl.timeSrv.setTime({\r\n        from: moment.utc(timeFrom),\r\n        to: moment.utc(timeTo)\r\n      });\r\n    }\r\n\r\n    clearSelection();\r\n  }\r\n\r\n  function onMouseLeave() {\r\n    // appEvents.emit('graph-hover-clear');\r\n    clearCrosshair();\r\n  }\r\n\r\n  function onMouseMove(event) {\r\n    if (!carpet) { return; }\r\n\r\n    const pos = getMousePos(event);\r\n    const posX = pos.x + yAxisWidth;\r\n\r\n    if (selection.active) {\r\n      clearCrosshair();\r\n      tooltip.destroy();\r\n\r\n      selection.x2 = posX;\r\n      drawSelection(selection.x1, selection.x2);\r\n    } else {\r\n      drawCrosshair(posX);\r\n      tooltip.show(event, pos, data);\r\n    }\r\n  }\r\n\r\n  function drawCrosshair(posX) {\r\n    if (!carpet || posX < yAxisWidth || posX > yAxisWidth + chartWidth) {\r\n      clearCrosshair();\r\n      return;\r\n    }\r\n\r\n    carpet.selectAll('.heatmap-crosshair').remove();\r\n\r\n    carpet.append('g')\r\n      .attr('class', 'heatmap-crosshair')\r\n      .attr('transform', `translate(${posX},0)`)\r\n      .append('line')\r\n      .attr('x1', 1)\r\n      .attr('y1', chartTop)\r\n      .attr('x2', 1)\r\n      .attr('y2', chartBottom)\r\n      .attr('stroke-width', 1);\r\n  }\r\n\r\n  function getMousePos(event) {\r\n    const { left, top } = $canvas[0].getBoundingClientRect();\r\n    const pos = {\r\n      x: event.pageX - window.scrollX - left,\r\n      y: event.pageY - window.scrollY - top\r\n    };\r\n    return pos;\r\n  }\r\n\r\n  function clearCrosshair() {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.heatmap-crosshair').remove();\r\n  }\r\n\r\n  function drawSelection(posX1, posX2) {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.carpet-selection').remove();\r\n    const selectionX = Math.min(posX1, posX2);\r\n    const selectionWidth = Math.abs(posX1 - posX2);\r\n\r\n    if (selectionWidth > MIN_SELECTION_WIDTH) {\r\n      carpet.append('rect')\r\n        .attr('class', 'carpet-selection')\r\n        .attr('x', selectionX)\r\n        .attr('width', selectionWidth)\r\n        .attr('y', chartTop)\r\n        .attr('height', chartHeight);\r\n    }\r\n  }\r\n\r\n  function clearSelection() {\r\n    selection.x1 = -1;\r\n    selection.x2 = -1;\r\n\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.carpet-selection').remove();\r\n  }\r\n\r\n  function drawColorLegend() {\r\n    d3.select(\"#heatmap-color-legend\").selectAll(\"rect\").remove();\r\n\r\n    const legend = d3.select(\"#heatmap-color-legend\");\r\n    const legendWidth = Math.floor($(d3.select(\"#heatmap-color-legend\").node()).outerWidth());\r\n    const legendHeight = d3.select(\"#heatmap-color-legend\").attr(\"height\");\r\n\r\n    drawLegend(legend, legendWidth, legendHeight);\r\n  }\r\n\r\n  function addLegend() {\r\n    if (!panel.legend.show) { return; }\r\n\r\n    const decimals = panel.data.decimals;\r\n    const format = panel.data.unitFormat;;\r\n    const formatter = valueFormatter(format, decimals);\r\n\r\n    const legendContainer = carpet.append('g')\r\n      .attr('class', 'carpet-legend')\r\n      .attr('transform', `translate(${yAxisWidth},${margin.top + chartHeight + xAxisHeight + LEGEND_TOP_MARGIN})`);\r\n\r\n    const legendHeight = LEGEND_HEIGHT / 2;\r\n    const labelMargin = 5;\r\n\r\n    const minLabel = createMinMaxLabel(legendContainer, formatter(min));\r\n    const maxLabel = createMinMaxLabel(legendContainer, formatter(max));\r\n    const $minLabel = $(minLabel.node());\r\n    const $maxLabel = $(maxLabel.node());\r\n\r\n    const labelHeight = Math.ceil(Math.max($minLabel.height(), $maxLabel.height()));\r\n    const labelWidth = Math.ceil(Math.max($minLabel.width(), $maxLabel.width()));\r\n    const legendMargin = labelWidth + 2 * labelMargin;\r\n    const labelY = (legendHeight - labelHeight + 8) / 2;\r\n\r\n    minLabel\r\n      .attr('x', legendMargin / 2)\r\n      .attr('y', labelY);\r\n    maxLabel\r\n      .attr('x', chartWidth - legendMargin / 2)\r\n      .attr('y', labelY);\r\n\r\n    const legend = legendContainer.append('g')\r\n      .attr('transform', `translate(${legendMargin},0)`);\r\n\r\n    const legendWidth = chartWidth - 2 * legendMargin;\r\n    drawLegend(legend, legendWidth, legendHeight);\r\n\r\n    const legendScale = d3.scaleLinear()\r\n      .domain([min, max])\r\n      .range([0, legendWidth]);\r\n\r\n    const legendAxis = d3.axisBottom(legendScale)\r\n      .ticks(20)\r\n      .tickFormat(formatter)\r\n      .tickSize(legendHeight);\r\n\r\n    legendContainer.append('g')\r\n      .attr('class', 'legend-axis')\r\n      .call(legendAxis)\r\n      .attr('transform', `translate(${legendMargin},0)`)\r\n      .select('.domain').remove();\r\n  }\r\n\r\n  function createMinMaxLabel(legendContainer, text) {\r\n    return legendContainer.append('text')\r\n      .attr('class', 'min-max-label')\r\n      .attr('y', 0)\r\n      .attr('x', 0)\r\n      .attr('dy', '0.71em')\r\n      .attr('text-anchor', 'middle')\r\n      .text(text);\r\n  }\r\n\r\n  function drawLegend(legend, legendWidth, legendHeight, rangeStep = 2) {\r\n    const legendColorScale = getColorScale(0, legendWidth);\r\n    const valuesRange = d3.range(0, legendWidth, rangeStep);\r\n\r\n    return legend.selectAll(\".heatmap-color-legend-rect\")\r\n      .data(valuesRange)\r\n      .enter()\r\n      .append(\"rect\")\r\n      .attr(\"x\", d => d)\r\n      .attr(\"y\", 0)\r\n      .attr(\"width\", rangeStep + 1) // Overlap rectangles to prevent gaps\r\n      .attr(\"height\", legendHeight)\r\n      .attr(\"stroke-width\", 0)\r\n      .attr(\"fill\", d => legendColorScale(d));\r\n  }\r\n\r\n  // Render\r\n\r\n  function render() {\r\n    data = ctrl.data;\r\n    panel = ctrl.panel;\r\n    timeRange = ctrl.range;\r\n\r\n    fragment = getFragment(panel.fragment);\r\n\r\n    if (!d3.select(\"#heatmap-color-legend\").empty()) {\r\n      drawColorLegend();\r\n    }\r\n\r\n    addCarpetplot();\r\n\r\n    scope.yAxisWidth = yAxisWidth;\r\n    scope.xAxisHeight = xAxisHeight;\r\n    scope.chartHeight = chartHeight;\r\n    scope.chartWidth = chartWidth;\r\n    scope.chartTop = chartTop;\r\n    scope.fragment = fragment;\r\n    scope.xFrom = xFrom;\r\n  }\r\n\r\n  $carpet.on('mousedown', onMouseDown);\r\n  $carpet.on('mousemove', onMouseMove);\r\n  $carpet.on('mouseleave', onMouseLeave);\r\n}"]}