{"version":3,"sources":["../src/tooltip.js"],"names":["d3","$","_","moment","valueFormatter","TOOLTIP_PADDING_X","TOOLTIP_PADDING_Y","CarpetplotTooltip","elem","scope","tooltip","dashboard","ctrl","panel","carpetPanel","mouseOverPoint","on","onMouseOver","bind","onMouseLeave","e","show","data","add","move","destroy","select","append","attr","remove","pos","panelRelY","isInChart","bucket","getBucket","tooltipTimeFormat","time","formatDate","decimals","format","yAxis","formatter","value","tooltipHtml","html","offsetX","offsetY","yAxisWidth","chartWidth","chartTop","chartHeight","fragment","xFrom","xTime","xScale","invert","yTime","yScale","dayIndex","startOf","diff","bucketIndex","getBucketIndex","has","getTime","buckets","node","tooltipWidth","clientWidth","tooltipHeight","clientHeight","left","pageX","top","pageY","window","innerWidth","pageYOffset","innerHeight","style"],"mappings":"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","file":"tooltip.js","sourcesContent":["import d3 from 'd3';\r\nimport $ from 'jquery';\r\nimport _ from 'lodash';\r\nimport moment from 'moment';\r\n\r\nimport { valueFormatter } from './formatting';\r\n\r\nlet TOOLTIP_PADDING_X = 30;\r\nlet TOOLTIP_PADDING_Y = 5;\r\n\r\nclass CarpetplotTooltip {\r\n\r\n  constructor(elem, scope) {\r\n    this.tooltip = null;\r\n    this.scope = scope;\r\n    this.dashboard = scope.ctrl.dashboard;\r\n    this.panel = scope.ctrl.panel;\r\n    this.carpetPanel = elem;\r\n    this.mouseOverPoint = false;\r\n\r\n    elem.on('mouseover', this.onMouseOver.bind(this));\r\n    elem.on('mouseleave', this.onMouseLeave.bind(this));\r\n  }\r\n\r\n  onMouseOver(e) {\r\n    if (!this.panel.tooltip.show || !this.scope.ctrl.data || !this.scope.ctrl.data.data) { return; }\r\n\r\n    if (!this.tooltip) {\r\n      this.add();\r\n      this.move(e);\r\n    }\r\n  }\r\n\r\n  onMouseLeave() {\r\n    this.destroy();\r\n  }\r\n\r\n  onMouseMove(e) {\r\n    if (!this.panel.tooltip.show) { return; }\r\n\r\n    this.move(e);\r\n  }\r\n\r\n  add() {\r\n    this.tooltip = d3.select('body')\r\n      .append('div')\r\n      .attr('class', 'carpet-tooltip graph-tooltip grafana-tooltip');\r\n  }\r\n\r\n  destroy() {\r\n    if (this.tooltip) {\r\n      this.tooltip.remove();\r\n    }\r\n\r\n    this.tooltip = null;\r\n  }\r\n\r\n  show(pos, data) {\r\n    if (!this.panel.tooltip.show || !data) { return; }\r\n    // shared tooltip mode\r\n    if (pos.panelRelY) {\r\n      return;\r\n    }\r\n\r\n    if (!this.isInChart(pos) || !this.tooltip) {\r\n      this.destroy();\r\n      return;\r\n    }\r\n\r\n    const bucket = this.getBucket(pos, data);\r\n    if (!bucket) {\r\n      this.destroy();\r\n      return;\r\n    }\r\n\r\n    const tooltipTimeFormat = 'ddd YYYY-MM-DD HH:mm:ss';\r\n    const time = this.dashboard.formatDate(bucket.time, tooltipTimeFormat);\r\n    const decimals = this.panel.tooltip.decimals || 5;\r\n    const format = this.panel.yAxis.format;\r\n    const formatter = valueFormatter(format, decimals);\r\n    const value = formatter(bucket.value);\r\n\r\n    let tooltipHtml = `\r\n      <div class='graph-tooltip-time'>${time}</div>\r\n      <div>\r\n      value: <b>${value}</b><br/>\r\n      </div>\r\n    `;\r\n\r\n    this.tooltip.html(tooltipHtml);\r\n\r\n    this.move(pos);\r\n  }\r\n\r\n  isInChart(pos) {\r\n    const { offsetX, offsetY } = pos;\r\n    const { yAxisWidth, chartWidth, chartTop, chartHeight } = this.scope;\r\n\r\n    return offsetX > yAxisWidth\r\n      && offsetX < yAxisWidth + chartWidth\r\n      && offsetY > chartTop\r\n      && offsetY < chartTop + chartHeight;\r\n  }\r\n\r\n  getBucket(pos, data) {\r\n    const { offsetX, offsetY } = pos;\r\n    const { yAxisWidth, chartTop, fragment, xFrom } = this.scope;\r\n\r\n    const xTime = this.scope.xScale.invert(offsetX - yAxisWidth);\r\n    const yTime = this.scope.yScale.invert(offsetY - chartTop);\r\n\r\n    const dayIndex = moment(xTime).startOf('day').diff(xFrom, 'days');\r\n    const bucketIndex = fragment.getBucketIndex(moment(yTime));\r\n\r\n    return _.has(data, `data[${dayIndex}].buckets[${bucketIndex}]`)\r\n      ? {\r\n        time: fragment.getTime(data.data[dayIndex].time, bucketIndex),\r\n        value: data.data[dayIndex].buckets[bucketIndex]\r\n      }\r\n      : null;\r\n  }\r\n\r\n  move(pos) {\r\n    if (!this.tooltip) { return; }\r\n\r\n    const elem = $(this.tooltip.node())[0];\r\n    const tooltipWidth = elem.clientWidth;\r\n    const tooltipHeight = elem.clientHeight;\r\n\r\n    let left = pos.pageX + TOOLTIP_PADDING_X;\r\n    let top = pos.pageY + TOOLTIP_PADDING_Y;\r\n\r\n    if (pos.pageX + tooltipWidth + 40 > window.innerWidth) {\r\n      left = pos.pageX - tooltipWidth - TOOLTIP_PADDING_X;\r\n    }\r\n\r\n    if (pos.pageY - window.pageYOffset + tooltipHeight + 20 > window.innerHeight) {\r\n      top = pos.pageY - tooltipHeight - TOOLTIP_PADDING_Y;\r\n    }\r\n\r\n    return this.tooltip\r\n      .style('left', left + 'px')\r\n      .style('top', top + 'px');\r\n  }\r\n}\r\n\r\nexport default CarpetplotTooltip;"]}