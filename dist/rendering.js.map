{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","timeRange","carpet","$carpet","find","tooltip","CarpetplotTooltip","margin","left","right","top","bottom","width","height","min","max","xFrom","xTo","days","chartHeight","chartWidth","chartTop","chartBottom","xAxisHeight","yAxisWidth","yScale","xScale","legendHeight","colorScale","fragment","mouseUpHandler","originalPointColor","selection","active","x1","x2","events","on","render","renderingCompleted","addCarpetplot","getMinMax","addCarpetplotCanvas","addAxes","addLegend","getColorScale","addPoints","Math","floor","remove","d3","select","append","attr","legend","show","LEGEND_HEIGHT","LEGEND_TOP_MARGIN","addYAxis","getYAxisWidth","Y_AXIS_TICK_PADDING","addXAxis","getXAxisHeight","yAxis","selectAll","style","xAxis","scaleTime","domain","moment","startOf","add","range","axisLeft","ticks","getYAxisTicks","tickFormat","value","format","tickSizeInner","tickSizeOuter","tickPadding","call","posY","posX","yAxisGroup","axisText","nodes","text","$","outerWidth","count","Y_AXIS_TICK_MIN_SIZE","step","ceil","timeHour","every","from","local","to","diff","axisBottom","getXAxisTicks","timeFormat","tickSize","dayWidth","addDayTicks","timeSaturday","timeMonday","axis","empty","totalHeight","node","X_AXIS_TICK_MIN_SIZE","timeDay","timeMonth","container","insert","cols","enter","day","time","toDate","pointScale","scaleLinear","points","d","i","buckets","color","nullColor","$points","event","mouseOverPoint","highlightPoint","resetPointHighLight","target","highlightColor","darker","currentPoint","scale","isSet","stats","colorScheme","_","colorSchemes","colorInterpolator","colorScaleInverted","invert","contextSrv","user","lightTheme","start","end","scaleSequential","prop","undefined","onMouseDown","offsetX","onMouseUp","document","one","unbind","selectionRange","abs","MIN_SELECTION_WIDTH","timeFrom","timeTo","timeSrv","setTime","utc","clearSelection","onMouseLeave","clearCrosshair","onMouseMove","destroy","limitSelection","drawSelection","drawCrosshair","position","posX1","posX2","selectionX","selectionWidth","drawColorLegend","legendWidth","drawLegend","decimals","formatter","valueFormatter","legendContainer","labelMargin","minLabel","createMinMaxLabel","maxLabel","$minLabel","$maxLabel","labelHeight","labelWidth","legendMargin","labelY","legendScale","legendAxis","rangeStep","legendColorScale","valuesRange","getFragment","appEvents","tickStep","DEFAULT_X_TICK_SIZE_PX"],"mappings":"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","file":"rendering.js","sourcesContent":["import d3 from 'd3';\r\nimport _ from 'lodash';\r\nimport { appEvents, contextSrv } from 'app/core/core';\r\nimport { tickStep } from 'app/core/utils/ticks';\r\nimport moment from 'moment';\r\nimport $ from 'jquery';\r\n\r\nimport { getFragment } from './fragments';\r\nimport CarpetplotTooltip from './tooltip';\r\nimport { valueFormatter } from './formatting';\r\n\r\nconst\r\n  DEFAULT_X_TICK_SIZE_PX = 100,\r\n  X_AXIS_TICK_MIN_SIZE = 100,\r\n  Y_AXIS_TICK_PADDING = 5,\r\n  Y_AXIS_TICK_MIN_SIZE = 20,\r\n  MIN_SELECTION_WIDTH = 2,\r\n  LEGEND_HEIGHT = 40,\r\n  LEGEND_TOP_MARGIN = 10;\r\n\r\nexport default function link(scope, elem, attrs, ctrl) {\r\n  let data, panel, timeRange, carpet;\r\n\r\n  const $carpet = elem.find('.carpetplot-panel');\r\n  const tooltip = new CarpetplotTooltip($carpet, scope);\r\n\r\n  const margin = { left: 25, right: 15, top: 10, bottom: 65 };\r\n\r\n  let width, height,\r\n    min, max,\r\n    xFrom, xTo, days,\r\n    chartHeight, chartWidth,\r\n    chartTop, chartBottom,\r\n    xAxisHeight, yAxisWidth,\r\n    yScale, xScale,\r\n    legendHeight,\r\n    colorScale, fragment,\r\n    mouseUpHandler,\r\n    originalPointColor;\r\n\r\n  const selection = {\r\n    active: false,\r\n    x1: -1,\r\n    x2: -1\r\n  };\r\n\r\n  ctrl.events.on('render', () => {\r\n    render();\r\n    ctrl.renderingCompleted();\r\n  });\r\n\r\n  function addCarpetplot() {\r\n    if (!data.data) { return; }\r\n\r\n    [min, max] = getMinMax();\r\n\r\n    addCarpetplotCanvas();\r\n    addAxes();\r\n    addLegend();\r\n\r\n    colorScale = getColorScale(min, max);\r\n\r\n    addPoints(colorScale);\r\n  }\r\n\r\n  function addCarpetplotCanvas() {\r\n    width = Math.floor($carpet.width());\r\n    height = ctrl.height;\r\n\r\n    if (carpet) {\r\n      carpet.remove();\r\n    }\r\n\r\n    carpet = d3.select($carpet[0])\r\n      .append('svg')\r\n      .attr('width', width)\r\n      .attr('height', height);\r\n  }\r\n\r\n  function addAxes() {\r\n    legendHeight = panel.legend.show ? LEGEND_HEIGHT + LEGEND_TOP_MARGIN : 0;\r\n    chartHeight = height - margin.top - margin.bottom - legendHeight;\r\n    chartTop = margin.top;\r\n    chartBottom = chartTop + chartHeight;\r\n\r\n    addYAxis();\r\n    yAxisWidth = getYAxisWidth() + Y_AXIS_TICK_PADDING;\r\n    chartWidth = width - yAxisWidth - margin.right;\r\n\r\n    addXAxis();\r\n    xAxisHeight = getXAxisHeight();\r\n\r\n    if (!panel.yAxis.show) {\r\n      carpet.select('.axis-y').selectAll('line').style('opacity', 0);\r\n    }\r\n\r\n    if (!panel.xAxis.show) {\r\n      carpet.select('.axis-x').selectAll('line').style('opacity', 0);\r\n      carpet.selectAll('.axis-x-weekends').selectAll('line').style('opacity', 0);\r\n    }\r\n  }\r\n\r\n  function addYAxis() {\r\n    scope.yScale = yScale = d3.scaleTime()\r\n      .domain([moment().startOf('day').add(1, 'day'), moment().startOf('day')])\r\n      .range([chartHeight, 0]);\r\n\r\n    const yAxis = d3.axisLeft(yScale)\r\n      .ticks(getYAxisTicks())\r\n      .tickFormat((value) => moment(value).format('HH:mm'))\r\n      .tickSizeInner(0 - width)\r\n      .tickSizeOuter(0)\r\n      .tickPadding(Y_AXIS_TICK_PADDING);\r\n\r\n    carpet.append('g')\r\n      .attr('class', 'axis axis-y')\r\n      .call(yAxis);\r\n\r\n    const posY = margin.top;\r\n    const posX = getYAxisWidth() + Y_AXIS_TICK_PADDING;\r\n\r\n    const yAxisGroup = carpet.select('.axis-y');\r\n    yAxisGroup.attr('transform', `translate(${posX},${posY})`);\r\n    yAxisGroup.select('.domain').remove();\r\n    yAxisGroup.select('.tick:first-child').remove();\r\n    yAxisGroup.selectAll('.tick line').remove();\r\n  }\r\n\r\n  function getYAxisWidth() {\r\n    const axisText = carpet.selectAll('.axis-y text').nodes();\r\n    return d3.max(axisText, (text) => $(text).outerWidth());\r\n  }\r\n\r\n  function getYAxisTicks() {\r\n    const count = chartHeight / Y_AXIS_TICK_MIN_SIZE;\r\n    const step = Math.max(2, Math.ceil(24 / count));\r\n    return d3.timeHour.every(step);\r\n  }\r\n\r\n  function addXAxis() {\r\n    xFrom = moment(data.from.local()).startOf('day');\r\n    xTo = moment(data.to.local()).startOf('day');\r\n    days = xTo.diff(xFrom, 'days');\r\n\r\n    scope.xScale = xScale = d3.scaleTime()\r\n      .domain([xFrom, xTo])\r\n      .range([0, chartWidth]);\r\n\r\n    const xAxis = d3.axisBottom(xScale)\r\n      .ticks(getXAxisTicks(xFrom, xTo))\r\n      .tickFormat(d3.timeFormat('%a %m/%d'))\r\n      .tickSize(chartHeight);\r\n\r\n    const dayWidth = chartWidth / days;\r\n\r\n    const posY = margin.top;\r\n    const posX = yAxisWidth;\r\n    carpet.append('g')\r\n      .attr('class', 'axis axis-x')\r\n      .attr('transform', `translate(${posX},${posY})`)\r\n    .call(xAxis)\r\n      .selectAll('text')\r\n      .style('text-anchor', 'end')\r\n      .attr('dx', '-.8em')\r\n      .attr('dy', '.15em')\r\n      .attr('y', 0)\r\n      .attr('transform', `translate(${5 + dayWidth / 2},${posY + chartHeight - 10}) rotate(-65)`);\r\n    carpet.select('.axis-x').selectAll('.tick line').remove();\r\n    carpet.select('.axis-x').select('.tick:last-child').remove();\r\n\r\n    addDayTicks(posX, posY, d3.timeSaturday.every(1));\r\n    addDayTicks(posX, posY, d3.timeMonday.every(1));\r\n  }\r\n\r\n  function addDayTicks(posX, posY, range) {\r\n    const ticks = d3.axisBottom(xScale)\r\n      .ticks(range)\r\n      .tickSize(chartHeight);\r\n    carpet.append('g')\r\n      .attr('class', 'axis-x-weekends')\r\n      .attr('transform', `translate(${posX},${posY})`)\r\n      .call(ticks)\r\n      .selectAll('text').remove();\r\n    carpet.select('.axis-x-weekends .domain').remove();\r\n  }\r\n\r\n  function getXAxisHeight() {\r\n    const axis = carpet.select('.axis-x');\r\n    if (!axis.empty()) {\r\n      const totalHeight = $(axis.node()).height();\r\n      return Math.max(0, totalHeight - chartHeight);\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  function getXAxisTicks(from, to) {\r\n    const count = chartWidth / X_AXIS_TICK_MIN_SIZE;\r\n    const step = Math.ceil(days / count);\r\n    if (step < 7) {\r\n      return d3.timeDay.every(1);\r\n    }\r\n    if (step < 28) {\r\n      return d3.timeMonday.every(1);\r\n    }\r\n    return d3.timeMonth.every(1);\r\n  }\r\n\r\n  function addPoints(colorScale) {\r\n    const container = carpet.insert('g', ':first-child')\r\n      .attr('class', 'carpet-container')\r\n      .attr('transform', `translate(${yAxisWidth},${margin.top})`);\r\n\r\n    const cols = container\r\n      .selectAll('.carpet-col')\r\n      .data(data.data)\r\n      .enter()\r\n      .append('g')\r\n      .attr('transform', (day) => `translate(${xScale(day.time.toDate())},0)`);\r\n\r\n    const width = chartWidth / days;\r\n    const height = chartHeight / fragment.count;\r\n\r\n    const pointScale = d3.scaleLinear()\r\n      .domain([fragment.count, 0])\r\n      .range([chartHeight, 0])\r\n\r\n    const points = cols\r\n      .selectAll('.carpet-point')\r\n      .data((d, i) => d.buckets)\r\n      .enter()\r\n      .append('rect')\r\n      .attr('class', 'carpet-point')\r\n      .attr('fill', value => value === null ? panel.color.nullColor : colorScale(value))\r\n      .attr('x', 0)\r\n      .attr('y', (d, i) => pointScale(i))\r\n      .attr('width', width)\r\n      .attr('height', height)\r\n      .attr('title', (d, i) => `${i}: ${d}`);\r\n\r\n    const $points = $carpet.find('.carpet-point');\r\n    $points\r\n      .on('mouseenter', (event) => {\r\n        tooltip.mouseOverPoint = true;\r\n        highlightPoint(event);\r\n      })\r\n      .on('mouseleave', (event) => {\r\n        tooltip.mouseOverPoint = false;\r\n        resetPointHighLight(event);\r\n      });\r\n  }\r\n\r\n  function highlightPoint(event) {\r\n    const color = d3.select(event.target).style('fill');\r\n    const highlightColor = d3.color(color).darker(1);\r\n    const currentPoint = d3.select(event.target);\r\n    originalPointColor = color;\r\n    currentPoint.style('fill', highlightColor);\r\n  }\r\n\r\n  function resetPointHighLight(event) {\r\n    d3.select(event.target)\r\n      .style('fill', originalPointColor);\r\n  }\r\n\r\n  function getMinMax() {\r\n    const { min, max } = panel.scale;\r\n    return [\r\n      isSet(min) ? min : data.stats.min,\r\n      isSet(max) ? max : data.stats.max\r\n    ];\r\n  }\r\n\r\n  function getColorScale(min, max) {\r\n    const colorScheme = _.find(ctrl.colorSchemes, { value: panel.color.colorScheme });\r\n    const colorInterpolator = d3[colorScheme.value];\r\n    const colorScaleInverted = colorScheme.invert === 'always' || (colorScheme.invert === 'dark' && !contextSrv.user.lightTheme);\r\n\r\n    const start = colorScaleInverted ? max : min;\r\n    const end = colorScaleInverted ? min : max;\r\n\r\n    return d3\r\n      .scaleSequential(colorInterpolator)\r\n      .domain([start, end]);\r\n  }\r\n\r\n  function isSet(prop) {\r\n    return prop !== undefined && prop !== null && prop !== '';\r\n  }\r\n\r\n  function onMouseDown(event) {\r\n    selection.active = true;\r\n    selection.x1 = event.offsetX;\r\n\r\n    mouseUpHandler = () => onMouseUp();\r\n\r\n    $(document).one('mouseup', mouseUpHandler);\r\n  }\r\n\r\n  function onMouseUp() {\r\n    $(document).unbind('mouseup', mouseUpHandler);\r\n    mouseUpHandler = null;\r\n    selection.active = false;\r\n\r\n    const selectionRange = Math.abs(selection.x2 - selection.x1);\r\n\r\n    if (selection.x2 >= 0 && selectionRange > MIN_SELECTION_WIDTH) {\r\n      const timeFrom = xScale.invert(Math.min(selection.x1, selection.x2) - yAxisWidth);\r\n      const timeTo = xScale.invert(Math.max(selection.x1, selection.x2) - yAxisWidth);\r\n\r\n      ctrl.timeSrv.setTime({\r\n        from: moment.utc(timeFrom),\r\n        to: moment.utc(timeTo)\r\n      });\r\n    }\r\n\r\n    clearSelection();\r\n  }\r\n\r\n  function onMouseLeave() {\r\n    // appEvents.emit('graph-hover-clear');\r\n    clearCrosshair();\r\n  }\r\n\r\n  function onMouseMove(event) {\r\n    if (!carpet) { return; }\r\n\r\n    if (selection.active) {\r\n      clearCrosshair();\r\n      tooltip.destroy();\r\n\r\n      selection.x2 = limitSelection(event.offsetX);\r\n      drawSelection(selection.x1, selection.x2);\r\n    } else {\r\n      drawCrosshair(event.offsetX);\r\n      tooltip.show(event, data);\r\n    }\r\n  }\r\n\r\n  function drawCrosshair(position) {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.heatmap-crosshair').remove();\r\n\r\n    let posX = position;\r\n    posX = Math.max(posX, yAxisWidth);\r\n    posX = Math.min(posX, chartWidth + yAxisWidth);\r\n\r\n    carpet.append('g')\r\n      .attr('class', 'heatmap-crosshair')\r\n      .attr('transform', 'translate(' + posX + ',0)')\r\n      .append('line')\r\n      .attr('x1', 1)\r\n      .attr('y1', chartTop)\r\n      .attr('x2', 1)\r\n      .attr('y2', chartBottom)\r\n      .attr('stroke-width', 1);\r\n\r\n  }\r\n\r\n  function clearCrosshair() {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.heatmap-crosshair').remove();\r\n  }\r\n\r\n  function limitSelection(x2) {\r\n    x2 = Math.max(x2, yAxisWidth);\r\n    x2 = Math.min(x2, chartWidth + yAxisWidth);\r\n    return x2;\r\n  }\r\n\r\n  function drawSelection(posX1, posX2) {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.carpet-selection').remove();\r\n    const selectionX = Math.min(posX1, posX2);\r\n    const selectionWidth = Math.abs(posX1 - posX2);\r\n\r\n    if (selectionWidth > MIN_SELECTION_WIDTH) {\r\n      carpet.append('rect')\r\n        .attr('class', 'carpet-selection')\r\n        .attr('x', selectionX)\r\n        .attr('width', selectionWidth)\r\n        .attr('y', chartTop)\r\n        .attr('height', chartHeight);\r\n    }\r\n  }\r\n\r\n  function clearSelection() {\r\n    selection.x1 = -1;\r\n    selection.x2 = -1;\r\n\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.carpet-selection').remove();\r\n  }\r\n\r\n  function drawColorLegend() {\r\n    d3.select(\"#heatmap-color-legend\").selectAll(\"rect\").remove();\r\n\r\n    const legend = d3.select(\"#heatmap-color-legend\");\r\n    const legendWidth = Math.floor($(d3.select(\"#heatmap-color-legend\").node()).outerWidth());\r\n    const legendHeight = d3.select(\"#heatmap-color-legend\").attr(\"height\");\r\n\r\n    drawLegend(legend, legendWidth, legendHeight);\r\n  }\r\n\r\n  function addLegend() {\r\n    if (!panel.legend.show) { return; }\r\n\r\n    const decimals = panel.tooltip.decimals || 5;\r\n    const format = panel.yAxis.format;\r\n    const formatter = valueFormatter(format, decimals);\r\n\r\n    const legendContainer = carpet.append('g')\r\n      .attr('class', 'carpet-legend')\r\n      .attr('transform', `translate(${yAxisWidth},${margin.top + chartHeight + xAxisHeight + LEGEND_TOP_MARGIN})`);\r\n\r\n    const legendHeight = LEGEND_HEIGHT / 2;\r\n    const labelMargin = 5;\r\n    \r\n    const minLabel = createMinMaxLabel(legendContainer, formatter(min));\r\n    const maxLabel = createMinMaxLabel(legendContainer, formatter(max));\r\n    const $minLabel = $(minLabel.node());\r\n    const $maxLabel = $(maxLabel.node());\r\n\r\n    const labelHeight = Math.ceil(Math.max($minLabel.height(), $maxLabel.height()));\r\n    const labelWidth = Math.ceil(Math.max($minLabel.width(), $maxLabel.width()));\r\n    const legendMargin = labelWidth + 2 * labelMargin;\r\n    const labelY = (legendHeight - labelHeight + 8) / 2;\r\n\r\n    minLabel\r\n      .attr('x', legendMargin / 2)\r\n      .attr('y', labelY);\r\n    maxLabel\r\n      .attr('x', chartWidth - legendMargin / 2)\r\n      .attr('y', labelY);\r\n\r\n    const legend = legendContainer.append('g')\r\n      .attr('transform', `translate(${legendMargin},0)`);\r\n\r\n    const legendWidth = chartWidth - 2 * legendMargin;\r\n    drawLegend(legend, legendWidth, legendHeight);\r\n\r\n    const legendScale = d3.scaleLinear()\r\n      .domain([min, max])\r\n      .range([0, legendWidth]);\r\n\r\n    const legendAxis = d3.axisBottom(legendScale)\r\n      .ticks(20)\r\n      .tickFormat(formatter)\r\n      .tickSize(legendHeight);\r\n\r\n    legendContainer.append('g')\r\n      .attr('class', 'legend-axis')\r\n      .call(legendAxis)\r\n      .attr('transform', `translate(${legendMargin},0)`)\r\n      .select('.domain').remove();\r\n  }\r\n\r\n  function createMinMaxLabel(legendContainer, text) {\r\n    return legendContainer.append('text')\r\n      .attr('class', 'min-max-label')\r\n      .attr('y', 0)\r\n      .attr('x', 0)\r\n      .attr('dy', '0.71em')\r\n      .attr('text-anchor', 'middle')\r\n      .text(text);\r\n  }\r\n\r\n  function drawLegend(legend, legendWidth, legendHeight, rangeStep = 2) {\r\n    const legendColorScale = getColorScale(0, legendWidth);\r\n    const valuesRange = d3.range(0, legendWidth, rangeStep);\r\n\r\n    return legend.selectAll(\".heatmap-color-legend-rect\")\r\n      .data(valuesRange)\r\n      .enter()\r\n      .append(\"rect\")\r\n      .attr(\"x\", d => d)\r\n      .attr(\"y\", 0)\r\n      .attr(\"width\", rangeStep + 1) // Overlap rectangles to prevent gaps\r\n      .attr(\"height\", legendHeight)\r\n      .attr(\"stroke-width\", 0)\r\n      .attr(\"fill\", d => legendColorScale(d));\r\n  }\r\n\r\n  // Render\r\n\r\n  function render() {\r\n    data = ctrl.data;\r\n    panel = ctrl.panel;\r\n    timeRange = ctrl.range;\r\n\r\n    fragment = getFragment(panel.fragment);\r\n\r\n    if (!d3.select(\"#heatmap-color-legend\").empty()) {\r\n      drawColorLegend();\r\n    }\r\n\r\n    addCarpetplot();\r\n\r\n    scope.yAxisWidth = yAxisWidth;\r\n    scope.xAxisHeight = xAxisHeight;\r\n    scope.chartHeight = chartHeight;\r\n    scope.chartWidth = chartWidth;\r\n    scope.chartTop = chartTop;\r\n    scope.fragment = fragment;\r\n    scope.xFrom = xFrom;\r\n  }\r\n\r\n  $carpet.on('mousedown', onMouseDown);\r\n  $carpet.on('mousemove', onMouseMove);\r\n  $carpet.on('mouseleave', onMouseLeave);\r\n}"]}