{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","timeRange","carpet","$carpet","find","tooltip","CarpetplotTooltip","margin","left","right","top","bottom","width","height","min","max","xFrom","xTo","days","chartHeight","chartWidth","chartTop","chartBottom","xAxisHeight","yAxisWidth","yScale","xScale","legendHeight","colorScale","fragment","mouseUpHandler","originalPointColor","$canvas","selection","active","x1","x2","events","on","render","renderingCompleted","addCarpetplot","getMinMax","addCarpetplotCanvas","addAxes","addLegend","getColorScale","addPoints","Math","floor","remove","d3","select","append","attr","legend","show","LEGEND_HEIGHT","LEGEND_TOP_MARGIN","addYAxis","getYAxisWidth","Y_AXIS_TICK_PADDING","addXAxis","getXAxisHeight","yAxis","selectAll","style","xAxis","scaleTime","domain","moment","startOf","add","range","axisLeft","ticks","getYAxisTicks","tickFormat","value","format","tickSizeInner","tickSizeOuter","tickPadding","call","posY","posX","yAxisGroup","axisText","nodes","text","$","outerWidth","count","Y_AXIS_TICK_MIN_SIZE","step","ceil","timeHour","every","time","length","diff","axisBottom","getXAxisTicks","timeFormat","tickSize","dayWidth","addDayTicks","timeSaturday","timeMonday","axis","empty","totalHeight","node","from","to","X_AXIS_TICK_MIN_SIZE","timeDay","timeMonth","container","insert","cols","enter","day","toDate","pointScale","scaleLinear","points","d","i","buckets","color","nullColor","$points","event","mouseOverPoint","highlightPoint","resetPointHighLight","target","highlightColor","darker","currentPoint","scale","isSet","stats","colorScheme","_","colorSchemes","colorInterpolator","colorScaleInverted","invert","contextSrv","user","lightTheme","start","end","scaleSequential","prop","undefined","onMouseDown","pos","getMousePos","x","onMouseUp","document","one","unbind","selectionRange","abs","MIN_SELECTION_WIDTH","timeFrom","timeTo","timeSrv","setTime","utc","clearSelection","onMouseLeave","clearCrosshair","onMouseMove","destroy","drawSelection","drawCrosshair","getBoundingClientRect","pageX","y","pageY","posX1","posX2","selectionX","selectionWidth","drawColorLegend","legendWidth","drawLegend","decimals","formatter","valueFormatter","legendContainer","labelMargin","minLabel","createMinMaxLabel","maxLabel","$minLabel","$maxLabel","labelHeight","labelWidth","legendMargin","labelY","legendScale","legendAxis","rangeStep","legendColorScale","valuesRange","getFragment","appEvents","tickStep","DEFAULT_X_TICK_SIZE_PX"],"mappings":"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","file":"rendering.js","sourcesContent":["import d3 from 'd3';\r\nimport _ from 'lodash';\r\nimport { appEvents, contextSrv } from 'app/core/core';\r\nimport { tickStep } from 'app/core/utils/ticks';\r\nimport moment from 'moment';\r\nimport $ from 'jquery';\r\n\r\nimport { getFragment } from './fragments';\r\nimport CarpetplotTooltip from './tooltip';\r\nimport { valueFormatter } from './formatting';\r\n\r\nconst\r\n  DEFAULT_X_TICK_SIZE_PX = 100,\r\n  X_AXIS_TICK_MIN_SIZE = 100,\r\n  Y_AXIS_TICK_PADDING = 5,\r\n  Y_AXIS_TICK_MIN_SIZE = 20,\r\n  MIN_SELECTION_WIDTH = 2,\r\n  LEGEND_HEIGHT = 40,\r\n  LEGEND_TOP_MARGIN = 10;\r\n\r\nexport default function link(scope, elem, attrs, ctrl) {\r\n  let data, panel, timeRange, carpet;\r\n\r\n  const $carpet = elem.find('.carpetplot-panel');\r\n  const tooltip = new CarpetplotTooltip($carpet, scope);\r\n\r\n  const margin = { left: 25, right: 15, top: 10, bottom: 65 };\r\n\r\n  let width, height,\r\n    min, max,\r\n    xFrom, xTo, days,\r\n    chartHeight, chartWidth,\r\n    chartTop, chartBottom,\r\n    xAxisHeight, yAxisWidth,\r\n    yScale, xScale,\r\n    legendHeight,\r\n    colorScale, fragment,\r\n    mouseUpHandler,\r\n    originalPointColor,\r\n    $canvas;\r\n\r\n  const selection = {\r\n    active: false,\r\n    x1: -1,\r\n    x2: -1\r\n  };\r\n\r\n  ctrl.events.on('render', () => {\r\n    render();\r\n    ctrl.renderingCompleted();\r\n  });\r\n\r\n  function addCarpetplot() {\r\n    if (!data.data) { return; }\r\n\r\n    [min, max] = getMinMax();\r\n\r\n    addCarpetplotCanvas();\r\n    addAxes();\r\n    addLegend();\r\n\r\n    colorScale = getColorScale(min, max);\r\n\r\n    addPoints(colorScale);\r\n  }\r\n\r\n  function addCarpetplotCanvas() {\r\n    width = Math.floor($carpet.width());\r\n    height = ctrl.height;\r\n\r\n    if (carpet) {\r\n      carpet.remove();\r\n    }\r\n\r\n    carpet = d3.select($carpet[0])\r\n      .append('svg')\r\n      .attr('width', width)\r\n      .attr('height', height);\r\n  }\r\n\r\n  function addAxes() {\r\n    legendHeight = panel.legend.show ? LEGEND_HEIGHT + LEGEND_TOP_MARGIN : 0;\r\n    chartHeight = height - margin.top - margin.bottom - legendHeight;\r\n    chartTop = margin.top;\r\n    chartBottom = chartTop + chartHeight;\r\n\r\n    addYAxis();\r\n    yAxisWidth = getYAxisWidth() + Y_AXIS_TICK_PADDING;\r\n    chartWidth = width - yAxisWidth - margin.right;\r\n\r\n    addXAxis();\r\n    xAxisHeight = getXAxisHeight();\r\n\r\n    if (!panel.yAxis.show) {\r\n      carpet.select('.axis-y').selectAll('line').style('opacity', 0);\r\n    }\r\n\r\n    if (!panel.xAxis.show) {\r\n      carpet.select('.axis-x').selectAll('line').style('opacity', 0);\r\n      carpet.selectAll('.axis-x-weekends').selectAll('line').style('opacity', 0);\r\n    }\r\n  }\r\n\r\n  function addYAxis() {\r\n    scope.yScale = yScale = d3.scaleTime()\r\n      .domain([moment().startOf('day').add(1, 'day'), moment().startOf('day')])\r\n      .range([chartHeight, 0]);\r\n\r\n    const yAxis = d3.axisLeft(yScale)\r\n      .ticks(getYAxisTicks())\r\n      .tickFormat((value) => moment(value).format('HH:mm'))\r\n      .tickSizeInner(0 - width)\r\n      .tickSizeOuter(0)\r\n      .tickPadding(Y_AXIS_TICK_PADDING);\r\n\r\n    carpet.append('g')\r\n      .attr('class', 'axis axis-y')\r\n      .call(yAxis);\r\n\r\n    const posY = margin.top;\r\n    const posX = getYAxisWidth() + Y_AXIS_TICK_PADDING;\r\n\r\n    const yAxisGroup = carpet.select('.axis-y');\r\n    yAxisGroup.attr('transform', `translate(${posX},${posY})`);\r\n    yAxisGroup.select('.domain').remove();\r\n    yAxisGroup.select('.tick:first-child').remove();\r\n    yAxisGroup.selectAll('.tick line').remove();\r\n  }\r\n\r\n  function getYAxisWidth() {\r\n    const axisText = carpet.selectAll('.axis-y text').nodes();\r\n    return d3.max(axisText, (text) => $(text).outerWidth());\r\n  }\r\n\r\n  function getYAxisTicks() {\r\n    const count = chartHeight / Y_AXIS_TICK_MIN_SIZE;\r\n    const step = Math.max(2, Math.ceil(24 / count));\r\n    return d3.timeHour.every(step);\r\n  }\r\n\r\n  function addXAxis() {\r\n    xFrom = moment(data.data[0].time).startOf('day');\r\n    xTo = moment(data.data[data.data.length - 1].time).startOf('day').add(1, 'day');\r\n    days = xTo.diff(xFrom, 'days');\r\n\r\n    scope.xScale = xScale = d3.scaleTime()\r\n      .domain([xFrom, xTo])\r\n      .range([0, chartWidth]);\r\n\r\n    const xAxis = d3.axisBottom(xScale)\r\n      .ticks(getXAxisTicks(xFrom, xTo))\r\n      .tickFormat(d3.timeFormat('%a %m/%d'))\r\n      .tickSize(chartHeight);\r\n\r\n    const dayWidth = chartWidth / days;\r\n\r\n    const posY = margin.top;\r\n    const posX = yAxisWidth;\r\n    carpet.append('g')\r\n      .attr('class', 'axis axis-x')\r\n      .attr('transform', `translate(${posX},${posY})`)\r\n      .call(xAxis)\r\n      .selectAll('text')\r\n      .style('text-anchor', 'end')\r\n      .attr('dx', '-.8em')\r\n      .attr('dy', '.15em')\r\n      .attr('y', 0)\r\n      .attr('transform', `translate(${5 + dayWidth / 2},${posY + chartHeight - 10}) rotate(-65)`);\r\n    carpet.select('.axis-x').selectAll('.tick line').remove();\r\n    carpet.select('.axis-x').select('.tick:last-child').remove();\r\n\r\n    addDayTicks(posX, posY, d3.timeSaturday.every(1));\r\n    addDayTicks(posX, posY, d3.timeMonday.every(1));\r\n  }\r\n\r\n  function addDayTicks(posX, posY, range) {\r\n    const ticks = d3.axisBottom(xScale)\r\n      .ticks(range)\r\n      .tickSize(chartHeight);\r\n    carpet.append('g')\r\n      .attr('class', 'axis-x-weekends')\r\n      .attr('transform', `translate(${posX},${posY})`)\r\n      .call(ticks)\r\n      .selectAll('text').remove();\r\n    carpet.select('.axis-x-weekends .domain').remove();\r\n  }\r\n\r\n  function getXAxisHeight() {\r\n    const axis = carpet.select('.axis-x');\r\n    if (!axis.empty()) {\r\n      const totalHeight = $(axis.node()).height();\r\n      return Math.max(0, totalHeight - chartHeight);\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  function getXAxisTicks(from, to) {\r\n    const count = chartWidth / X_AXIS_TICK_MIN_SIZE;\r\n    const step = Math.ceil(days / count);\r\n    if (step < 7) {\r\n      return d3.timeDay.every(1);\r\n    }\r\n    if (step < 28) {\r\n      return d3.timeMonday.every(1);\r\n    }\r\n    return d3.timeMonth.every(1);\r\n  }\r\n\r\n  function addPoints(colorScale) {\r\n    const container = carpet.insert('g', ':first-child')\r\n      .attr('class', 'carpet-container')\r\n      .attr('transform', `translate(${yAxisWidth},${margin.top})`);\r\n\r\n    $canvas = $(container.node());\r\n\r\n    const cols = container\r\n      .selectAll('.carpet-col')\r\n      .data(data.data)\r\n      .enter()\r\n      .append('g')\r\n      .attr('transform', (day) => `translate(${xScale(day.time.toDate())},0)`);\r\n\r\n    const width = Math.max(0, chartWidth / days);\r\n    const height = Math.max(0, chartHeight / fragment.count);\r\n\r\n    const pointScale = d3.scaleLinear()\r\n      .domain([fragment.count, 0])\r\n      .range([chartHeight, 0])\r\n\r\n    const points = cols\r\n      .selectAll('.carpet-point')\r\n      .data((d, i) => d.buckets)\r\n      .enter()\r\n      .append('rect')\r\n      .attr('class', 'carpet-point')\r\n      .attr('fill', value => value === null ? panel.color.nullColor : colorScale(value))\r\n      .attr('x', 0)\r\n      .attr('y', (d, i) => pointScale(i))\r\n      .attr('width', width)\r\n      .attr('height', height)\r\n      .attr('title', (d, i) => `${i}: ${d}`);\r\n\r\n    const $points = $carpet.find('.carpet-point');\r\n    $points\r\n      .on('mouseenter', (event) => {\r\n        tooltip.mouseOverPoint = true;\r\n        highlightPoint(event);\r\n      })\r\n      .on('mouseleave', (event) => {\r\n        tooltip.mouseOverPoint = false;\r\n        resetPointHighLight(event);\r\n      });\r\n  }\r\n\r\n  function highlightPoint(event) {\r\n    const color = d3.select(event.target).style('fill');\r\n    const highlightColor = d3.color(color).darker(1);\r\n    const currentPoint = d3.select(event.target);\r\n    originalPointColor = color;\r\n    currentPoint.style('fill', highlightColor);\r\n  }\r\n\r\n  function resetPointHighLight(event) {\r\n    d3.select(event.target)\r\n      .style('fill', originalPointColor);\r\n  }\r\n\r\n  function getMinMax() {\r\n    const { min, max } = panel.scale;\r\n    return [\r\n      isSet(min) ? min : data.stats.min,\r\n      isSet(max) ? max : data.stats.max\r\n    ];\r\n  }\r\n\r\n  function getColorScale(min, max) {\r\n    const colorScheme = _.find(ctrl.colorSchemes, { value: panel.color.colorScheme });\r\n    const colorInterpolator = d3[colorScheme.value];\r\n    const colorScaleInverted = colorScheme.invert === 'always' || (colorScheme.invert === 'dark' && !contextSrv.user.lightTheme);\r\n\r\n    const start = colorScaleInverted ? max : min;\r\n    const end = colorScaleInverted ? min : max;\r\n\r\n    return d3\r\n      .scaleSequential(colorInterpolator)\r\n      .domain([start, end]);\r\n  }\r\n\r\n  function isSet(prop) {\r\n    return prop !== undefined && prop !== null && prop !== '';\r\n  }\r\n\r\n  function onMouseDown(event) {\r\n    selection.active = true;\r\n    const pos = getMousePos(event);\r\n    const posX = pos.x + yAxisWidth;\r\n    selection.x1 = posX;\r\n\r\n    mouseUpHandler = () => onMouseUp();\r\n\r\n    $(document).one('mouseup', mouseUpHandler);\r\n  }\r\n\r\n  function onMouseUp() {\r\n    $(document).unbind('mouseup', mouseUpHandler);\r\n    mouseUpHandler = null;\r\n    selection.active = false;\r\n\r\n    const selectionRange = Math.abs(selection.x2 - selection.x1);\r\n\r\n    if (selection.x2 >= 0 && selectionRange > MIN_SELECTION_WIDTH) {\r\n      const timeFrom = xScale.invert(Math.min(selection.x1, selection.x2) - yAxisWidth);\r\n      const timeTo = xScale.invert(Math.max(selection.x1, selection.x2) - yAxisWidth);\r\n\r\n      ctrl.timeSrv.setTime({\r\n        from: moment.utc(timeFrom),\r\n        to: moment.utc(timeTo)\r\n      });\r\n    }\r\n\r\n    clearSelection();\r\n  }\r\n\r\n  function onMouseLeave() {\r\n    // appEvents.emit('graph-hover-clear');\r\n    clearCrosshair();\r\n  }\r\n\r\n  function onMouseMove(event) {\r\n    if (!carpet) { return; }\r\n\r\n    const pos = getMousePos(event);\r\n    const posX = pos.x + yAxisWidth;\r\n\r\n    if (selection.active) {\r\n      clearCrosshair();\r\n      tooltip.destroy();\r\n\r\n      selection.x2 = posX;\r\n      drawSelection(selection.x1, selection.x2);\r\n    } else {\r\n      drawCrosshair(posX);\r\n      tooltip.show(event, pos, data);\r\n    }\r\n  }\r\n\r\n  function drawCrosshair(posX) {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.heatmap-crosshair').remove();\r\n\r\n    carpet.append('g')\r\n      .attr('class', 'heatmap-crosshair')\r\n      .attr('transform', `translate(${posX},0)`)\r\n      .append('line')\r\n      .attr('x1', 1)\r\n      .attr('y1', chartTop)\r\n      .attr('x2', 1)\r\n      .attr('y2', chartBottom)\r\n      .attr('stroke-width', 1);\r\n\r\n  }\r\n\r\n  function getMousePos(event) {\r\n    const { left, top } = $canvas[0].getBoundingClientRect();\r\n    const pos = {\r\n      x: event.pageX - left, chartWidth,\r\n      y: event.pageY - top, chartHeight\r\n    };\r\n    return pos;\r\n  }\r\n\r\n  function clearCrosshair() {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.heatmap-crosshair').remove();\r\n  }\r\n\r\n  function drawSelection(posX1, posX2) {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.carpet-selection').remove();\r\n    const selectionX = Math.min(posX1, posX2);\r\n    const selectionWidth = Math.abs(posX1 - posX2);\r\n\r\n    if (selectionWidth > MIN_SELECTION_WIDTH) {\r\n      carpet.append('rect')\r\n        .attr('class', 'carpet-selection')\r\n        .attr('x', selectionX)\r\n        .attr('width', selectionWidth)\r\n        .attr('y', chartTop)\r\n        .attr('height', chartHeight);\r\n    }\r\n  }\r\n\r\n  function clearSelection() {\r\n    selection.x1 = -1;\r\n    selection.x2 = -1;\r\n\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.carpet-selection').remove();\r\n  }\r\n\r\n  function drawColorLegend() {\r\n    d3.select(\"#heatmap-color-legend\").selectAll(\"rect\").remove();\r\n\r\n    const legend = d3.select(\"#heatmap-color-legend\");\r\n    const legendWidth = Math.floor($(d3.select(\"#heatmap-color-legend\").node()).outerWidth());\r\n    const legendHeight = d3.select(\"#heatmap-color-legend\").attr(\"height\");\r\n\r\n    drawLegend(legend, legendWidth, legendHeight);\r\n  }\r\n\r\n  function addLegend() {\r\n    if (!panel.legend.show) { return; }\r\n\r\n    const decimals = panel.tooltip.decimals || 5;\r\n    const format = panel.yAxis.format;\r\n    const formatter = valueFormatter(format, decimals);\r\n\r\n    const legendContainer = carpet.append('g')\r\n      .attr('class', 'carpet-legend')\r\n      .attr('transform', `translate(${yAxisWidth},${margin.top + chartHeight + xAxisHeight + LEGEND_TOP_MARGIN})`);\r\n\r\n    const legendHeight = LEGEND_HEIGHT / 2;\r\n    const labelMargin = 5;\r\n\r\n    const minLabel = createMinMaxLabel(legendContainer, formatter(min));\r\n    const maxLabel = createMinMaxLabel(legendContainer, formatter(max));\r\n    const $minLabel = $(minLabel.node());\r\n    const $maxLabel = $(maxLabel.node());\r\n\r\n    const labelHeight = Math.ceil(Math.max($minLabel.height(), $maxLabel.height()));\r\n    const labelWidth = Math.ceil(Math.max($minLabel.width(), $maxLabel.width()));\r\n    const legendMargin = labelWidth + 2 * labelMargin;\r\n    const labelY = (legendHeight - labelHeight + 8) / 2;\r\n\r\n    minLabel\r\n      .attr('x', legendMargin / 2)\r\n      .attr('y', labelY);\r\n    maxLabel\r\n      .attr('x', chartWidth - legendMargin / 2)\r\n      .attr('y', labelY);\r\n\r\n    const legend = legendContainer.append('g')\r\n      .attr('transform', `translate(${legendMargin},0)`);\r\n\r\n    const legendWidth = chartWidth - 2 * legendMargin;\r\n    drawLegend(legend, legendWidth, legendHeight);\r\n\r\n    const legendScale = d3.scaleLinear()\r\n      .domain([min, max])\r\n      .range([0, legendWidth]);\r\n\r\n    const legendAxis = d3.axisBottom(legendScale)\r\n      .ticks(20)\r\n      .tickFormat(formatter)\r\n      .tickSize(legendHeight);\r\n\r\n    legendContainer.append('g')\r\n      .attr('class', 'legend-axis')\r\n      .call(legendAxis)\r\n      .attr('transform', `translate(${legendMargin},0)`)\r\n      .select('.domain').remove();\r\n  }\r\n\r\n  function createMinMaxLabel(legendContainer, text) {\r\n    return legendContainer.append('text')\r\n      .attr('class', 'min-max-label')\r\n      .attr('y', 0)\r\n      .attr('x', 0)\r\n      .attr('dy', '0.71em')\r\n      .attr('text-anchor', 'middle')\r\n      .text(text);\r\n  }\r\n\r\n  function drawLegend(legend, legendWidth, legendHeight, rangeStep = 2) {\r\n    const legendColorScale = getColorScale(0, legendWidth);\r\n    const valuesRange = d3.range(0, legendWidth, rangeStep);\r\n\r\n    return legend.selectAll(\".heatmap-color-legend-rect\")\r\n      .data(valuesRange)\r\n      .enter()\r\n      .append(\"rect\")\r\n      .attr(\"x\", d => d)\r\n      .attr(\"y\", 0)\r\n      .attr(\"width\", rangeStep + 1) // Overlap rectangles to prevent gaps\r\n      .attr(\"height\", legendHeight)\r\n      .attr(\"stroke-width\", 0)\r\n      .attr(\"fill\", d => legendColorScale(d));\r\n  }\r\n\r\n  // Render\r\n\r\n  function render() {\r\n    data = ctrl.data;\r\n    panel = ctrl.panel;\r\n    timeRange = ctrl.range;\r\n\r\n    fragment = getFragment(panel.fragment);\r\n\r\n    if (!d3.select(\"#heatmap-color-legend\").empty()) {\r\n      drawColorLegend();\r\n    }\r\n\r\n    addCarpetplot();\r\n\r\n    scope.yAxisWidth = yAxisWidth;\r\n    scope.xAxisHeight = xAxisHeight;\r\n    scope.chartHeight = chartHeight;\r\n    scope.chartWidth = chartWidth;\r\n    scope.chartTop = chartTop;\r\n    scope.fragment = fragment;\r\n    scope.xFrom = xFrom;\r\n  }\r\n\r\n  $carpet.on('mousedown', onMouseDown);\r\n  $carpet.on('mousemove', onMouseMove);\r\n  $carpet.on('mouseleave', onMouseLeave);\r\n}"]}