{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","timeRange","carpet","$carpet","find","margin","left","right","top","bottom","width","height","min","max","xFrom","xTo","days","chartHeight","chartWidth","chartTop","chartBottom","xAxisHeight","yAxisWidth","yScale","xScale","colorScale","fragment","selection","active","x1","x2","events","on","render","renderingCompleted","addCarpetplot","addCarpetplotCanvas","addAxes","getMinMax","getColorScale","addPoints","Math","floor","remove","d3","select","append","attr","addYAxis","getYAxisWidth","Y_AXIS_TICK_PADDING","addXAxis","getXAxisHeight","scaleTime","domain","moment","startOf","add","range","yAxis","axisLeft","ticks","timeHour","every","tickFormat","value","format","tickSizeInner","tickSizeOuter","tickPadding","call","posY","posX","yAxisGroup","selectAll","axisText","nodes","text","$","outerWidth","from","local","to","diff","xAxis","axisBottom","getXAxisTicks","timeFormat","tickSize","style","axisLine","empty","axisLinePosition","parseFloat","canvasHeight","count","X_AXIS_TICK_MIN_SIZE","step","ceil","timeDay","timeWeek","timeMonth","container","insert","cols","enter","day","time","toDate","pointScale","scaleLinear","points","d","i","buckets","color","nullColor","scale","isSet","stats","colorScheme","_","colorSchemes","colorInterpolator","colorScaleInverted","invert","contextSrv","user","lightTheme","start","end","scaleSequential","prop","undefined","onMouseDown","event","onMouseUp","onMouseLeave","clearCrosshair","onMouseMove","limitSelection","offsetX","drawSelection","drawCrosshair","position","posX1","posX2","getFragment","console","log","appEvents","tickStep","DEFAULT_X_TICK_SIZE_PX","MIN_SELECTION_WIDTH"],"mappings":"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","file":"rendering.js","sourcesContent":["import d3 from 'd3';\r\nimport _ from 'lodash';\r\nimport { appEvents, contextSrv } from 'app/core/core';\r\nimport { tickStep } from 'app/core/utils/ticks';\r\nimport moment from 'moment';\r\n\r\nimport { getFragment } from './fragments';\r\n\r\nconst\r\n  DEFAULT_X_TICK_SIZE_PX = 100,\r\n  X_AXIS_TICK_MIN_SIZE = 100,\r\n  Y_AXIS_TICK_PADDING = 5,\r\n  MIN_SELECTION_WIDTH = 2;\r\n\r\nexport default function link(scope, elem, attrs, ctrl) {\r\n  let data, panel, timeRange, carpet;\r\n\r\n  const $carpet = elem.find('.carpetplot-panel');\r\n\r\n  // const padding = { left: 0, right: 0, top: 0, bottom: 0 };\r\n  const margin = { left: 25, right: 15, top: 10, bottom: 65 };\r\n\r\n  let width, height,\r\n    min, max,\r\n    xFrom, xTo, days,\r\n    chartHeight, chartWidth,\r\n    chartTop, chartBottom,\r\n    xAxisHeight, yAxisWidth,\r\n    yScale, xScale,\r\n    colorScale, fragment;\r\n\r\n  const selection = {\r\n    active: false,\r\n    x1: -1,\r\n    x2: -1\r\n  };\r\n\r\n  ctrl.events.on('render', () => {\r\n    render();\r\n    ctrl.renderingCompleted();\r\n  });\r\n\r\n  function addCarpetplot() {\r\n    if (!data.data) { return; }\r\n\r\n    addCarpetplotCanvas();\r\n    addAxes();\r\n\r\n    [min, max] = getMinMax();\r\n    colorScale = getColorScale(min, max);\r\n\r\n    addPoints(colorScale);\r\n  }\r\n\r\n  function addCarpetplotCanvas() {\r\n    width = Math.floor($carpet.width());\r\n    height = ctrl.height;\r\n\r\n    if (carpet) {\r\n      carpet.remove();\r\n    }\r\n\r\n    carpet = d3.select($carpet[0])\r\n      .append('svg')\r\n      .attr('width', width)\r\n      .attr('height', height);\r\n  }\r\n\r\n  function addAxes() {\r\n    chartHeight = height - margin.top - margin.bottom;\r\n    chartTop = margin.top;\r\n    chartBottom = chartTop + chartHeight;\r\n\r\n    addYAxis();\r\n    yAxisWidth = getYAxisWidth() + Y_AXIS_TICK_PADDING;\r\n    chartWidth = width - yAxisWidth - margin.right;\r\n\r\n    addXAxis();\r\n    xAxisHeight = getXAxisHeight();\r\n\r\n    // if (!panel.yAxis.show) {\r\n    //   heatmap.select('.axis-y').selectAll('line').style('opacity', 0);\r\n    // }\r\n\r\n    // if (!panel.xAxis.show) {\r\n    //   heatmap.select('.axis-x').selectAll('line').style('opacity', 0);\r\n    // }\r\n  }\r\n\r\n  function addYAxis() {\r\n    scope.yScale = yScale = d3.scaleTime()\r\n      .domain([moment().startOf('day').add(1, 'day'), moment().startOf('day')])\r\n      .range([chartHeight, 0]);\r\n\r\n    const yAxis = d3.axisLeft(yScale)\r\n      .ticks(d3.timeHour.every(4))\r\n      .tickFormat((value) => moment(value).format('HH:mm'))\r\n      .tickSizeInner(0 - width)\r\n      .tickSizeOuter(0)\r\n      .tickPadding(Y_AXIS_TICK_PADDING);\r\n\r\n    carpet.append('g')\r\n      .attr('class', 'axis axis-y')\r\n      .call(yAxis);\r\n\r\n    const posY = margin.top;\r\n    const posX = getYAxisWidth() + Y_AXIS_TICK_PADDING;\r\n\r\n    const yAxisGroup = carpet.select('.axis-y');\r\n    yAxisGroup.attr('transform', `translate(${posX},${posY})`);\r\n    yAxisGroup.select('.domain').remove();\r\n    yAxisGroup.selectAll('.tick line').remove();\r\n  }\r\n\r\n  function getYAxisWidth() {\r\n    const axisText = carpet.selectAll('.axis-y text').nodes();\r\n    return d3.max(axisText, (text) => $(text).outerWidth());\r\n  }\r\n\r\n  function addXAxis() {\r\n    xFrom = moment(data.from.local()).startOf('day');\r\n    xTo = moment(data.to.local()).startOf('day');\r\n    days = xTo.diff(xFrom, 'days');\r\n\r\n    scope.xScale = xScale = d3.scaleTime()\r\n      .domain([xFrom, xTo])\r\n      .range([0, chartWidth]);\r\n\r\n    const xAxis = d3.axisBottom(xScale)\r\n      .ticks(getXAxisTicks(xFrom, xTo))\r\n      .tickFormat(d3.timeFormat('%a %m/%d'))\r\n      .tickSize(chartHeight);\r\n\r\n    const posY = margin.top;\r\n    const posX = yAxisWidth;\r\n    carpet.append('g')\r\n      .attr('class', 'axis axis-x')\r\n      .attr('transform', `translate(${posX},${posY})`)\r\n      .call(xAxis)\r\n      .selectAll('text')\r\n      .style('text-anchor', 'end')\r\n      .attr('dx', '-.8em')\r\n      .attr('dy', '.15em')\r\n      .attr('y', 0)\r\n      .attr('transform', `translate(5,${posY + chartHeight - 10}) rotate(-65)`);\r\n\r\n    carpet.select('.axis-x').select('.domain').remove();\r\n  }\r\n\r\n  function getXAxisHeight() {\r\n    const axisLine = carpet.select('.axis-x line');\r\n    if (!axisLine.empty()) {\r\n      const axisLinePosition = parseFloat(carpet.select('.axis-x line').attr('y2'));\r\n      const canvasHeight = parseFloat(carpet.attr('height'));\r\n      return canvasHeight - axisLinePosition;\r\n    } else {\r\n      // Default height\r\n      return 30;\r\n    }\r\n  }\r\n\r\n  function getXAxisTicks(from, to) {\r\n    const count = chartWidth / X_AXIS_TICK_MIN_SIZE;\r\n    const step = Math.ceil(days / count);\r\n    if (step < 7) {\r\n      return d3.timeDay.every(step);\r\n    }\r\n    if (step < 28) {\r\n      return d3.timeWeek.every(Math.floor(step / 7));\r\n    }\r\n    return d3.timeMonth.every(1);\r\n  }\r\n\r\n  function addPoints(colorScale) {\r\n    const container = carpet.insert('g', ':first-child')\r\n      .attr('class', 'carpet-container')\r\n      .attr('transform', `translate(${yAxisWidth},${margin.top})`);\r\n\r\n    const cols = container\r\n      .selectAll('.carpet-col')\r\n      .data(data.data)\r\n      .enter()\r\n      .append('g')\r\n      .attr('transform', (day) => `translate(${xScale(day.time.toDate())},0)`);\r\n\r\n    const width = chartWidth / days;\r\n    const height = chartHeight / fragment.count;\r\n    const pointScale = d3.scaleLinear()\r\n      .domain([24, 0])\r\n      .range([chartHeight, 0])\r\n\r\n    const points = cols\r\n      .selectAll('.carpet-point')\r\n      .data((d, i) => d.buckets)\r\n      .enter()\r\n      .append('rect')\r\n      .attr('fill', value => value === null ? panel.color.nullColor : colorScale(value))\r\n      .attr('x', 0)\r\n      .attr('y', (d, i) => pointScale(i))\r\n      .attr('width', width)\r\n      .attr('height', height)\r\n      .attr('title', (d, i) => `${i}: ${d}`);\r\n  }\r\n\r\n  function getMinMax() {\r\n    const { min, max } = panel.scale;\r\n    return [\r\n      isSet(min) ? min : data.stats.min,\r\n      isSet(max) ? max : data.stats.max\r\n    ];\r\n  }\r\n\r\n  function getColorScale(min, max) {\r\n    const colorScheme = _.find(ctrl.colorSchemes, { value: panel.color.colorScheme });\r\n    const colorInterpolator = d3[colorScheme.value];\r\n    const colorScaleInverted = colorScheme.invert === 'always' || (colorScheme.invert === 'dark' && !contextSrv.user.lightTheme);\r\n\r\n    const start = colorScaleInverted ? max : min;\r\n    const end = colorScaleInverted ? min : max;\r\n\r\n    return d3\r\n      .scaleSequential(colorInterpolator)\r\n      .domain([start, end]);\r\n  }\r\n\r\n  function isSet(prop) {\r\n    return prop !== undefined && prop !== null && prop !== '';\r\n  }\r\n\r\n  // Selection, Crosshair, Tooltip\r\n  // appEvents.on('graph-hover', event => {\r\n  //   drawSharedCrosshair(event.pos);\r\n  // }, scope);\r\n\r\n  // appEvents.on('graph-hover-clear', () => {\r\n  //   clearCrosshair();\r\n  // }, scope);\r\n\r\n  function onMouseDown(event) {\r\n    // selection.active = true;\r\n    // selection.x1 = event.offsetX;\r\n\r\n    // mouseUpHandler = function () {\r\n    //   onMouseUp();\r\n    // };\r\n\r\n    // $(document).one(\"mouseup\", mouseUpHandler);\r\n  }\r\n\r\n  function onMouseUp() {\r\n    // $(document).unbind(\"mouseup\", mouseUpHandler);\r\n    // mouseUpHandler = null;\r\n    // selection.active = false;\r\n\r\n    // let selectionRange = Math.abs(selection.x2 - selection.x1);\r\n    // if (selection.x2 >= 0 && selectionRange > MIN_SELECTION_WIDTH) {\r\n    //   let timeFrom = xScale.invert(Math.min(selection.x1, selection.x2) - yAxisWidth);\r\n    //   let timeTo = xScale.invert(Math.max(selection.x1, selection.x2) - yAxisWidth);\r\n\r\n    //   ctrl.timeSrv.setTime({\r\n    //     from: moment.utc(timeFrom),\r\n    //     to: moment.utc(timeTo)\r\n    //   });\r\n    // }\r\n\r\n    // clearSelection();\r\n  }\r\n\r\n  function onMouseLeave() {\r\n    // appEvents.emit('graph-hover-clear');\r\n    clearCrosshair();\r\n  }\r\n\r\n  function onMouseMove(event) {\r\n    if (!carpet) { return; }\r\n\r\n    if (selection.active) {\r\n      clearCrosshair();\r\n      // tooltip.destroy();\r\n\r\n      selection.x2 = limitSelection(event.offsetX);\r\n      drawSelection(selection.x1, selection.x2);\r\n    } else {\r\n      drawCrosshair(event.offsetX);\r\n      // tooltip.show(event, data);\r\n    }\r\n  }\r\n\r\n  function drawCrosshair(position) {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll(\".heatmap-crosshair\").remove();\r\n\r\n    let posX = position;\r\n    posX = Math.max(posX, yAxisWidth);\r\n    posX = Math.min(posX, chartWidth + yAxisWidth);\r\n\r\n    carpet.append(\"g\")\r\n      .attr(\"class\", \"heatmap-crosshair\")\r\n      .attr(\"transform\", \"translate(\" + posX + \",0)\")\r\n      .append(\"line\")\r\n      .attr(\"x1\", 1)\r\n      .attr(\"y1\", chartTop)\r\n      .attr(\"x2\", 1)\r\n      .attr(\"y2\", chartBottom)\r\n      .attr(\"stroke-width\", 1);\r\n\r\n  }\r\n\r\n  // function drawSharedCrosshair(pos) {\r\n  //   if (!carpet || ctrl.dashboard.graphTooltip === 0) { return; }\r\n\r\n  //   const posX = xScale(pos.x) + yAxisWidth;\r\n  //   drawCrosshair(posX);\r\n  // }\r\n\r\n  function clearCrosshair() {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll(\".heatmap-crosshair\").remove();\r\n  }\r\n\r\n  function limitSelection(x2) {\r\n    x2 = Math.max(x2, yAxisWidth);\r\n    x2 = Math.min(x2, chartWidth + yAxisWidth);\r\n    return x2;\r\n  }\r\n\r\n  function drawSelection(posX1, posX2) {\r\n    // TODO\r\n  }\r\n\r\n  // Render\r\n\r\n  function render() {\r\n    data = ctrl.data;\r\n    panel = ctrl.panel;\r\n    timeRange = ctrl.range;\r\n\r\n    fragment = getFragment(panel.fragment);\r\n\r\n    console.log(data)\r\n\r\n    addCarpetplot();\r\n  }\r\n\r\n  $carpet.on(\"mousedown\", onMouseDown);\r\n  $carpet.on(\"mousemove\", onMouseMove);\r\n  $carpet.on(\"mouseleave\", onMouseLeave);\r\n}"]}