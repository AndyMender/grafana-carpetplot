{"version":3,"sources":["../../src/canvas/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","timeRange","carpet","canvas","context","$carpet","find","tooltip","CarpetplotTooltip","margin","left","right","top","bottom","width","height","min","max","xFrom","xTo","days","chartHeight","chartWidth","chartTop","chartBottom","xAxisHeight","yAxisWidth","yScale","xScale","legendHeight","colorScale","fragment","mouseUpHandler","originalPointColor","pointWidth","pointHeight","highlightedBucket","$canvas","selection","active","x1","x2","events","on","render","renderingCompleted","addCarpetplot","getMinMax","getColorScale","addCarpetplotSvg","addAxes","addLegend","addCanvas","addPoints","Math","floor","remove","d3","select","append","attr","legend","show","LEGEND_HEIGHT","LEGEND_TOP_MARGIN","addYAxis","getYAxisWidth","Y_AXIS_TICK_PADDING","addXAxis","getXAxisHeight","yAxis","selectAll","style","xAxis","scaleTime","domain","moment","startOf","add","range","axisLeft","ticks","getYAxisTicks","tickFormat","value","format","tickSizeInner","tickSizeOuter","tickPadding","call","posY","posX","yAxisGroup","axisText","nodes","text","$","outerWidth","count","Y_AXIS_TICK_MIN_SIZE","step","ceil","timeHour","every","time","length","diff","axisBottom","getXAxisTicks","timeFormat","tickSize","dayWidth","showWeekends","minBucketWidthToShowWeekends","addDayTicks","timeSaturday","timeMonday","axis","empty","totalHeight","node","from","to","X_AXIS_TICK_MIN_SIZE","timeDay","timeMonth","insert","getContext","customBase","document","createElement","container","pointScale","scaleLinear","cols","enter","points","d","i","buckets","map","color","nullColor","toDate","drawPoints","clearRect","elements","each","fillStyle","fillRect","scale","isSet","stats","colorScheme","_","colorSchemes","colorInterpolator","colorScaleInverted","invert","contextSrv","user","lightTheme","start","end","scaleSequential","prop","undefined","onMouseDown","event","pos","getMousePos","isInChart","x","onMouseUp","one","unbind","selectionRange","abs","MIN_SELECTION_WIDTH","timeFrom","timeTo","timeSrv","setTime","utc","clearSelection","onMouseLeave","clearCrosshair","onMouseMove","destroy","drawSelection","drawCrosshair","bucket","getBucket","highlightPoint","hasValue","resetPointHighLight","equals","y","highlightColor","darker","getBoundingClientRect","pageX","pageY","window","scrollX","scrollY","crosshair","showCrosshair","posX1","posX2","selectionX","selectionWidth","drawColorLegend","legendWidth","drawLegend","decimals","unitFormat","formatter","valueFormatter","legendContainer","labelMargin","minLabel","createMinMaxLabel","maxLabel","$minLabel","$maxLabel","labelHeight","labelWidth","legendMargin","labelY","legendScale","legendAxis","rangeStep","legendColorScale","valuesRange","xTime","yTime","dayIndex","bucketIndex","getBucketIndex","bucketX","bucketY","has","getTime","hasData","getFragment","appEvents","tickStep","DEFAULT_X_TICK_SIZE_PX"],"mappings":"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","file":"rendering.js","sourcesContent":["import d3 from 'd3';\r\nimport _ from 'lodash';\r\nimport { appEvents, contextSrv } from 'app/core/core';\r\nimport { tickStep } from 'app/core/utils/ticks';\r\nimport moment from 'moment';\r\nimport $ from 'jquery';\r\n\r\nimport { getFragment } from '../fragments';\r\nimport CarpetplotTooltip from './tooltip';\r\nimport { valueFormatter } from '../formatting';\r\n\r\nconst\r\n  DEFAULT_X_TICK_SIZE_PX = 100,\r\n  X_AXIS_TICK_MIN_SIZE = 100,\r\n  Y_AXIS_TICK_PADDING = 5,\r\n  Y_AXIS_TICK_MIN_SIZE = 20,\r\n  MIN_SELECTION_WIDTH = 2,\r\n  LEGEND_HEIGHT = 40,\r\n  LEGEND_TOP_MARGIN = 10;\r\n\r\nexport default function link(scope, elem, attrs, ctrl) {\r\n  let data, panel, timeRange, carpet, canvas, context;\r\n\r\n  const $carpet = elem.find('.carpetplot-panel');\r\n  const tooltip = new CarpetplotTooltip($carpet, scope);\r\n\r\n  const margin = { left: 25, right: 15, top: 10, bottom: 65 };\r\n\r\n  let width, height,\r\n    min, max,\r\n    xFrom, xTo, days,\r\n    chartHeight, chartWidth,\r\n    chartTop, chartBottom,\r\n    xAxisHeight, yAxisWidth,\r\n    yScale, xScale,\r\n    legendHeight,\r\n    colorScale, fragment,\r\n    mouseUpHandler,\r\n    originalPointColor,\r\n    pointWidth, pointHeight,\r\n    highlightedBucket,\r\n    $canvas;\r\n\r\n  const selection = {\r\n    active: false,\r\n    x1: -1,\r\n    x2: -1\r\n  };\r\n\r\n  ctrl.events.on('render', () => {\r\n    render();\r\n    ctrl.renderingCompleted();\r\n  });\r\n\r\n  function addCarpetplot() {\r\n    if (!data.data) { return; }\r\n\r\n    [min, max] = getMinMax();\r\n    colorScale = getColorScale(min, max);\r\n\r\n    addCarpetplotSvg();\r\n    addAxes();\r\n    addLegend();\r\n    addCanvas();\r\n    addPoints();\r\n  }\r\n\r\n  function addCarpetplotSvg() {\r\n    width = Math.floor($carpet.width());\r\n    height = ctrl.height;\r\n\r\n    if (carpet) {\r\n      carpet.remove();\r\n    }\r\n\r\n    carpet = d3.select($carpet[0])\r\n      .append('svg')\r\n      .attr('width', width)\r\n      .attr('height', height);\r\n  }\r\n\r\n  function addAxes() {\r\n    legendHeight = panel.legend.show ? LEGEND_HEIGHT + LEGEND_TOP_MARGIN : 0;\r\n    chartHeight = height - margin.top - margin.bottom - legendHeight;\r\n    chartTop = margin.top;\r\n    chartBottom = chartTop + chartHeight;\r\n\r\n    addYAxis();\r\n    yAxisWidth = getYAxisWidth() + Y_AXIS_TICK_PADDING;\r\n    chartWidth = width - yAxisWidth - margin.right;\r\n\r\n    addXAxis();\r\n    xAxisHeight = getXAxisHeight();\r\n\r\n    if (!panel.yAxis.show) {\r\n      carpet.select('.axis-y').selectAll('line').style('opacity', 0);\r\n    }\r\n\r\n    if (!panel.xAxis.show) {\r\n      carpet.select('.axis-x').selectAll('line').style('opacity', 0);\r\n      carpet.selectAll('.axis-x-weekends').selectAll('line').style('opacity', 0);\r\n    }\r\n  }\r\n\r\n  function addYAxis() {\r\n    yScale = d3.scaleTime()\r\n      .domain([moment().startOf('day').add(1, 'day'), moment().startOf('day')])\r\n      .range([chartHeight, 0]);\r\n\r\n    const yAxis = d3.axisLeft(yScale)\r\n      .ticks(getYAxisTicks())\r\n      .tickFormat((value) => moment(value).format('HH:mm'))\r\n      .tickSizeInner(0 - width)\r\n      .tickSizeOuter(0)\r\n      .tickPadding(Y_AXIS_TICK_PADDING);\r\n\r\n    carpet.append('g')\r\n      .attr('class', 'axis axis-y')\r\n      .call(yAxis);\r\n\r\n    const posY = margin.top;\r\n    const posX = getYAxisWidth() + Y_AXIS_TICK_PADDING;\r\n\r\n    const yAxisGroup = carpet.select('.axis-y');\r\n    yAxisGroup.attr('transform', `translate(${posX},${posY})`);\r\n    yAxisGroup.select('.domain').remove();\r\n    yAxisGroup.select('.tick:first-child').remove();\r\n    yAxisGroup.selectAll('.tick line').remove();\r\n  }\r\n\r\n  function getYAxisWidth() {\r\n    const axisText = carpet.selectAll('.axis-y text').nodes();\r\n    return d3.max(axisText, (text) => $(text).outerWidth());\r\n  }\r\n\r\n  function getYAxisTicks() {\r\n    const count = chartHeight / Y_AXIS_TICK_MIN_SIZE;\r\n    const step = Math.max(2, Math.ceil(24 / count));\r\n    return d3.timeHour.every(step);\r\n  }\r\n\r\n  function addXAxis() {\r\n    xFrom = moment(data.data[0].time).startOf('day');\r\n    xTo = moment(data.data[data.data.length - 1].time).startOf('day').add(1, 'day');\r\n    days = xTo.diff(xFrom, 'days');\r\n\r\n    xScale = d3.scaleTime()\r\n      .domain([xFrom, xTo])\r\n      .range([0, chartWidth]);\r\n\r\n    const xAxis = d3.axisBottom(xScale)\r\n      .ticks(getXAxisTicks(xFrom, xTo))\r\n      .tickFormat(d3.timeFormat('%a %m/%d'))\r\n      .tickSize(chartHeight);\r\n\r\n    const dayWidth = chartWidth / days;\r\n\r\n    const posY = margin.top;\r\n    const posX = yAxisWidth;\r\n    carpet.append('g')\r\n      .attr('class', 'axis axis-x')\r\n      .attr('transform', `translate(${posX},${posY})`)\r\n      .call(xAxis)\r\n      .selectAll('text')\r\n      .style('text-anchor', 'end')\r\n      .attr('dx', '-.8em')\r\n      .attr('dy', '.15em')\r\n      .attr('y', 0)\r\n      .attr('transform', `translate(${5 + dayWidth / 2},${posY + chartHeight - 10}) rotate(-65)`);\r\n    carpet.select('.axis-x').selectAll('.tick line, .domain').remove();\r\n    carpet.select('.axis-x').select('.tick:last-child').remove();\r\n\r\n    if (panel.xAxis.showWeekends && dayWidth >= panel.xAxis.minBucketWidthToShowWeekends) {\r\n      addDayTicks(posX, posY, d3.timeSaturday.every(1));\r\n      addDayTicks(posX, posY, d3.timeMonday.every(1));\r\n    }\r\n  }\r\n\r\n  function addDayTicks(posX, posY, range) {\r\n    const ticks = d3.axisBottom(xScale)\r\n      .ticks(range)\r\n      .tickSize(chartHeight);\r\n    carpet.append('g')\r\n      .attr('class', 'axis-x-weekends')\r\n      .attr('transform', `translate(${posX},${posY})`)\r\n      .call(ticks)\r\n      .selectAll('text').remove();\r\n    carpet.select('.axis-x-weekends .domain').remove();\r\n  }\r\n\r\n  function getXAxisHeight() {\r\n    const axis = carpet.select('.axis-x');\r\n    if (!axis.empty()) {\r\n      const totalHeight = $(axis.node()).height();\r\n      return Math.max(totalHeight, totalHeight - chartHeight);\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  function getXAxisTicks(from, to) {\r\n    const count = chartWidth / X_AXIS_TICK_MIN_SIZE;\r\n    const step = Math.ceil(days / count);\r\n    if (step < 7) {\r\n      return d3.timeDay.every(1);\r\n    }\r\n    if (step < 28) {\r\n      return d3.timeMonday.every(1);\r\n    }\r\n    return d3.timeMonth.every(1);\r\n  }\r\n\r\n  function addCanvas() {\r\n    if (canvas) {\r\n      canvas.remove();\r\n    }\r\n\r\n    canvas = d3.select($carpet[0])\r\n      .insert('canvas', ':first-child')\r\n      .attr('width', chartWidth)\r\n      .attr('height', chartHeight)\r\n      .style('left', `${yAxisWidth}px`)\r\n      .style('top', `${margin.top}px`);\r\n\r\n    $canvas = $(canvas.node());\r\n\r\n    context = canvas.node().getContext('2d');\r\n  }\r\n\r\n  function addPoints() {\r\n    const customBase = document.createElement('custom');\r\n\r\n    const container = d3.select(customBase);\r\n\r\n    pointWidth = Math.max(0, chartWidth / days);\r\n    pointHeight = Math.max(0, chartHeight / fragment.count);\r\n\r\n    const pointScale = d3.scaleLinear()\r\n      .domain([fragment.count, 0])\r\n      .range([chartHeight, 0]);\r\n\r\n    const cols = container\r\n      .selectAll('custom.carpet-col')\r\n      .data(data.data)\r\n      .enter()\r\n      .append('custom')\r\n      .attr('class', 'carpet-col');\r\n\r\n    const points = cols\r\n      .selectAll('custom.carpet-point')\r\n      .data((d, i) => d.buckets.map(value => ({\r\n        value,\r\n        time: d.time\r\n      })))\r\n      .enter()\r\n      .append('custom')\r\n      .attr('class', 'carpet-point')\r\n      .attr('fillStyle', ({ value }) => value === null ? panel.color.nullColor : colorScale(value))\r\n      .attr('x', (d) => xScale(d.time.toDate()))\r\n      .attr('y', (d, i) => pointScale(i));\r\n\r\n    drawPoints(cols);\r\n  }\r\n\r\n  function drawPoints(cols) {\r\n    context.clearRect(0, 0, chartWidth, chartHeight);\r\n\r\n    const elements = cols.selectAll('custom.carpet-point')\r\n      .each(function (d, i) {\r\n        const node = d3.select(this);\r\n\r\n        context.fillStyle = node.attr('fillStyle');\r\n        context.fillRect(node.attr('x'), node.attr('y'), pointWidth, pointHeight);\r\n      });\r\n  }\r\n\r\n  function getMinMax() {\r\n    const { min, max } = panel.scale;\r\n    return [\r\n      isSet(min) ? min : data.stats.min,\r\n      isSet(max) ? max : data.stats.max\r\n    ];\r\n  }\r\n\r\n  function getColorScale(min, max) {\r\n    const colorScheme = _.find(ctrl.colorSchemes, { value: panel.color.colorScheme });\r\n    const colorInterpolator = d3[colorScheme.value];\r\n    const colorScaleInverted = colorScheme.invert === 'always' || (colorScheme.invert === 'dark' && !contextSrv.user.lightTheme);\r\n\r\n    const start = colorScaleInverted ? max : min;\r\n    const end = colorScaleInverted ? min : max;\r\n\r\n    return d3\r\n      .scaleSequential(colorInterpolator)\r\n      .domain([start, end]);\r\n  }\r\n\r\n  function isSet(prop) {\r\n    return prop !== undefined && prop !== null && prop !== '';\r\n  }\r\n\r\n  function onMouseDown(event) {\r\n    const pos = getMousePos(event);\r\n    if (!isInChart(pos)) { return; }\r\n\r\n    selection.active = true;\r\n    selection.x1 = pos.x;\r\n\r\n    mouseUpHandler = () => onMouseUp();\r\n\r\n    $(document).one('mouseup', mouseUpHandler);\r\n  }\r\n\r\n  function onMouseUp() {\r\n    $(document).unbind('mouseup', mouseUpHandler);\r\n    mouseUpHandler = null;\r\n    selection.active = false;\r\n\r\n    const selectionRange = Math.abs(selection.x2 - selection.x1);\r\n\r\n    if (selection.x2 >= 0 && selectionRange > MIN_SELECTION_WIDTH) {\r\n      const timeFrom = moment(xScale.invert(Math.min(selection.x1, selection.x2))).startOf('day');\r\n      const timeTo = moment(xScale.invert(Math.max(selection.x1, selection.x2))).startOf('day').add(1, 'day');\r\n\r\n      ctrl.timeSrv.setTime({\r\n        from: moment.utc(timeFrom),\r\n        to: moment.utc(timeTo)\r\n      });\r\n    }\r\n\r\n    clearSelection();\r\n  }\r\n\r\n  function onMouseLeave() {\r\n    // appEvents.emit('graph-hover-clear');\r\n    clearCrosshair();\r\n  }\r\n\r\n  function onMouseMove(event) {\r\n    if (!carpet) { return; }\r\n\r\n    const pos = getMousePos(event);\r\n\r\n    if (selection.active) {\r\n      clearCrosshair();\r\n      tooltip.destroy();\r\n\r\n      selection.x2 = pos.x;\r\n      drawSelection(selection.x1, selection.x2);\r\n    } else {\r\n      drawCrosshair(pos);\r\n\r\n      const bucket = getBucket(pos);\r\n      tooltip.show(pos, bucket);\r\n      highlightPoint(pos, bucket);\r\n    }\r\n  }\r\n\r\n  function highlightPoint(pos, bucket) {\r\n    if (!isInChart(pos) || !bucket || !bucket.hasValue()) {\r\n      resetPointHighLight();\r\n      return;\r\n    }\r\n\r\n    if (bucket.equals(highlightedBucket)) {\r\n      return;\r\n    } else {\r\n      resetPointHighLight();\r\n    }\r\n\r\n    highlightedBucket = bucket;\r\n\r\n    const { value, x, y } = bucket;\r\n\r\n    const color = colorScale(value);\r\n    const highlightColor = d3.color(color).darker(1);\r\n    originalPointColor = color;\r\n\r\n    context.fillStyle = highlightColor;\r\n    context.fillRect(x, y, pointWidth, pointHeight);\r\n  }\r\n\r\n  function resetPointHighLight() {\r\n    if (!highlightedBucket) { return; }\r\n\r\n    const { x, y } = highlightedBucket;\r\n    context.fillStyle = originalPointColor;\r\n    context.fillRect(x, y, pointWidth, pointHeight);\r\n\r\n    highlightedBucket = null;\r\n  }\r\n\r\n  function getMousePos(event) {\r\n    const { left, top } = $canvas[0].getBoundingClientRect();\r\n    const { pageX, pageY } = event;\r\n    const pos = {\r\n      x: pageX - window.scrollX - left,\r\n      y: pageY - window.scrollY - top,\r\n      pageX,\r\n      pageY\r\n    };\r\n    return pos;\r\n  }\r\n\r\n  function drawCrosshair(pos) {\r\n    if (!carpet || !isInChart(pos)) {\r\n      clearCrosshair();\r\n      return;\r\n    }\r\n\r\n    carpet.selectAll('.heatmap-crosshair').remove();\r\n\r\n    const x = pos.x + yAxisWidth;\r\n    const y = pos.y + chartTop;\r\n\r\n    const crosshair = carpet.append('g')\r\n      .attr('class', 'heatmap-crosshair');\r\n\r\n    if (panel.xAxis.showCrosshair) {\r\n      crosshair.append('line')\r\n        .attr('x1', x)\r\n        .attr('y1', chartTop)\r\n        .attr('x2', x)\r\n        .attr('y2', chartBottom)\r\n        .attr('stroke-width', 1);\r\n    }\r\n\r\n    if (panel.yAxis.showCrosshair) {\r\n      crosshair.append('line')\r\n        .attr('x1', yAxisWidth)\r\n        .attr('y1', y)\r\n        .attr('x2', yAxisWidth + chartWidth)\r\n        .attr('y2', y)\r\n        .attr('stroke-width', 1);\r\n    }\r\n  }\r\n\r\n  function clearCrosshair() {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.heatmap-crosshair').remove();\r\n  }\r\n\r\n  function drawSelection(posX1, posX2) {\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.carpet-selection').remove();\r\n    const selectionX = Math.min(posX1, posX2) + yAxisWidth;\r\n    const selectionWidth = Math.abs(posX1 - posX2);\r\n\r\n    if (selectionWidth > MIN_SELECTION_WIDTH) {\r\n      carpet.append('rect')\r\n        .attr('class', 'carpet-selection')\r\n        .attr('x', selectionX)\r\n        .attr('width', selectionWidth)\r\n        .attr('y', chartTop)\r\n        .attr('height', chartHeight);\r\n    }\r\n  }\r\n\r\n  function clearSelection() {\r\n    selection.x1 = -1;\r\n    selection.x2 = -1;\r\n\r\n    if (!carpet) { return; }\r\n\r\n    carpet.selectAll('.carpet-selection').remove();\r\n  }\r\n\r\n  function drawColorLegend() {\r\n    d3.select(\"#heatmap-color-legend\").selectAll(\"rect\").remove();\r\n\r\n    const legend = d3.select(\"#heatmap-color-legend\");\r\n    const legendWidth = Math.floor($(d3.select(\"#heatmap-color-legend\").node()).outerWidth());\r\n    const legendHeight = d3.select(\"#heatmap-color-legend\").attr(\"height\");\r\n\r\n    drawLegend(legend, legendWidth, legendHeight);\r\n  }\r\n\r\n  function addLegend() {\r\n    if (!panel.legend.show) { return; }\r\n\r\n    const decimals = panel.data.decimals;\r\n    const format = panel.data.unitFormat;\r\n    const formatter = valueFormatter(format, decimals);\r\n\r\n    const legendContainer = carpet.append('g')\r\n      .attr('class', 'carpet-legend')\r\n      .attr('transform', `translate(${yAxisWidth},${margin.top + chartHeight + xAxisHeight + LEGEND_TOP_MARGIN})`);\r\n\r\n    const legendHeight = LEGEND_HEIGHT / 2;\r\n    const labelMargin = 5;\r\n\r\n    const minLabel = createMinMaxLabel(legendContainer, formatter(min));\r\n    const maxLabel = createMinMaxLabel(legendContainer, formatter(max));\r\n    const $minLabel = $(minLabel.node());\r\n    const $maxLabel = $(maxLabel.node());\r\n\r\n    const labelHeight = Math.ceil(Math.max($minLabel.height(), $maxLabel.height()));\r\n    const labelWidth = Math.ceil(Math.max($minLabel.width(), $maxLabel.width()));\r\n    const legendMargin = labelWidth + 2 * labelMargin;\r\n    const labelY = (legendHeight - labelHeight + 8) / 2;\r\n\r\n    minLabel\r\n      .attr('x', legendMargin / 2)\r\n      .attr('y', labelY);\r\n    maxLabel\r\n      .attr('x', chartWidth - legendMargin / 2)\r\n      .attr('y', labelY);\r\n\r\n    const legend = legendContainer.append('g')\r\n      .attr('transform', `translate(${legendMargin},0)`);\r\n\r\n    const legendWidth = chartWidth - 2 * legendMargin;\r\n    drawLegend(legend, legendWidth, legendHeight);\r\n\r\n    const legendScale = d3.scaleLinear()\r\n      .domain([min, max])\r\n      .range([0, legendWidth]);\r\n\r\n    const legendAxis = d3.axisBottom(legendScale)\r\n      .ticks(20)\r\n      .tickFormat(formatter)\r\n      .tickSize(legendHeight);\r\n\r\n    legendContainer.append('g')\r\n      .attr('class', 'legend-axis')\r\n      .call(legendAxis)\r\n      .attr('transform', `translate(${legendMargin},0)`)\r\n      .select('.domain').remove();\r\n  }\r\n\r\n  function createMinMaxLabel(legendContainer, text) {\r\n    return legendContainer.append('text')\r\n      .attr('class', 'min-max-label')\r\n      .attr('y', 0)\r\n      .attr('x', 0)\r\n      .attr('dy', '0.71em')\r\n      .attr('text-anchor', 'middle')\r\n      .text(text);\r\n  }\r\n\r\n  function drawLegend(legend, legendWidth, legendHeight, rangeStep = 2) {\r\n    const legendColorScale = getColorScale(0, legendWidth);\r\n    const valuesRange = d3.range(0, legendWidth, rangeStep);\r\n\r\n    return legend.selectAll(\".heatmap-color-legend-rect\")\r\n      .data(valuesRange)\r\n      .enter()\r\n      .append(\"rect\")\r\n      .attr(\"x\", d => d)\r\n      .attr(\"y\", 0)\r\n      .attr(\"width\", rangeStep + 1) // Overlap rectangles to prevent gaps\r\n      .attr(\"height\", legendHeight)\r\n      .attr(\"stroke-width\", 0)\r\n      .attr(\"fill\", d => legendColorScale(d));\r\n  }\r\n\r\n  // Helpers\r\n\r\n  function isInChart(pos) {\r\n    const { x, y } = pos;\r\n\r\n    return x > 0\r\n      && x < chartWidth\r\n      && y > 0\r\n      && y < chartHeight;\r\n  }\r\n\r\n  function getBucket(pos) {\r\n    const { x, y } = pos;\r\n\r\n    const xTime = moment(xScale.invert(x)).startOf('day');\r\n    const yTime = moment(yScale.invert(y));\r\n\r\n    const dayIndex = xTime.diff(xFrom, 'days');\r\n    const bucketIndex = fragment.getBucketIndex(yTime);\r\n\r\n    const bucketX = xScale(xTime.toDate());\r\n    const bucketY = pointHeight * bucketIndex;\r\n\r\n    return _.has(data, `data[${dayIndex}].buckets[${bucketIndex}]`)\r\n      ? {\r\n        x: bucketX,\r\n        y: bucketY,\r\n        time: fragment.getTime(data.data[dayIndex].time, bucketIndex),\r\n        value: data.data[dayIndex].buckets[bucketIndex],\r\n        hasValue() {\r\n          return this.value !== null;\r\n        },\r\n        equals(bucket) {\r\n          return bucket && bucket.x === this.x && bucket.y === this.y;\r\n        }\r\n      }\r\n      : null;\r\n  }\r\n\r\n  function hasData() {\r\n    return data && data.data;\r\n  }\r\n\r\n  // Render\r\n\r\n  function render() {\r\n    data = ctrl.data;\r\n    panel = ctrl.panel;\r\n    timeRange = ctrl.range;\r\n\r\n    fragment = getFragment(panel.fragment);\r\n\r\n    if (!d3.select(\"#heatmap-color-legend\").empty()) {\r\n      drawColorLegend();\r\n    }\r\n\r\n    addCarpetplot();\r\n\r\n    scope.hasData = hasData;\r\n    scope.isInChart = isInChart;\r\n  }\r\n\r\n  $carpet.on('mousedown', onMouseDown);\r\n  $carpet.on('mousemove', onMouseMove);\r\n  $carpet.on('mouseleave', onMouseLeave);\r\n}"]}